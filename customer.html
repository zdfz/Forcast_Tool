<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Customer Input</title>
	<link rel="icon" type="image/png" href="favicon.png">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/styles.css">
	<style>
		/* Date input styling */
		input[type="date"] {
			font-family: inherit;
			font-size: 14px;
			position: relative;
		}

		/* Date input styling */
		input[type="date"] {
			font-family: inherit;
			font-size: 14px;
		}

		/* Date validation styling */
		.date-input.is-invalid {
			border-color: #dc3545 !important;
			box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
		}

		.date-input.is-invalid:focus {
			border-color: #dc3545 !important;
			box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
		}

		.date-input {
			border: 2px solid #e0e0e0;
			transition: border-color 0.3s ease;
		}

		.date-input:focus {
			border-color: #007bff;
			box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
		}

		/* Service Mix Styles */
		.service-mix-container {
			display: flex;
			gap: 1rem;
			flex-wrap: wrap;
			margin-top: 0.5rem;
		}
		
		.service-option {
			position: relative;
			flex: 1;
			min-width: 150px;
		}
		
		.service-option input[type="checkbox"] {
			position: absolute;
			opacity: 0;
			width: 0;
			height: 0;
		}
		
		.service-option-label {
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 1.5rem 1rem;
			border: 2px solid #e9ecef;
			border-radius: 12px;
			background: #fff;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: center;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}
		
		.service-option-label:hover {
			border-color: #007bff;
			box-shadow: 0 4px 12px rgba(0,123,255,0.15);
			transform: translateY(-2px);
		}
		
		.service-option input:checked + .service-option-label {
			border-color: #007bff;
			background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
			color: white;
			box-shadow: 0 6px 20px rgba(0,123,255,0.3);
			transform: translateY(-3px);
		}
		
		.service-icon {
			font-size: 2rem;
			margin-bottom: 0.5rem;
			opacity: 0.8;
		}
		
		.service-option input:checked + .service-option-label .service-icon {
			opacity: 1;
			transform: scale(1.1);
		}
		
		.service-text {
			font-weight: 500;
			font-size: 0.95rem;
			line-height: 1.3;
		}
		
		@media (max-width: 768px) {
			.service-mix-container {
				flex-direction: column;
			}
			
			.service-option {
				min-width: 100%;
			}
			
			.service-option-label {
				flex-direction: row;
				text-align: left;
				padding: 1rem;
			}
			
			.service-icon {
				margin-bottom: 0;
				margin-right: 0.75rem;
				font-size: 1.5rem;
			}
		}

		/* Custom Toast Styles */
		.custom-toast {
			position: fixed;
			top: 20px;
			right: 20px;
			min-width: 300px;
			max-width: 400px;
			background: white;
			border-radius: 12px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
			z-index: 9999;
			transform: translateX(100%);
			transition: transform 0.3s ease, opacity 0.3s ease;
			opacity: 0;
			border-left: 4px solid #6c757d;
		}

		.custom-toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		.custom-toast.toast-success {
			border-left-color: #28a745;
		}

		.custom-toast.toast-warning {
			border-left-color: #ffc107;
		}

		.custom-toast.toast-error {
			border-left-color: #dc3545;
		}

		.custom-toast.toast-info {
			border-left-color: #17a2b8;
		}

		.toast-content {
			display: flex;
			align-items: flex-start;
			padding: 16px;
			gap: 12px;
		}

		.toast-icon {
			font-size: 20px;
			margin-top: 2px;
		}

		.toast-success .toast-icon {
			color: #28a745;
		}

		.toast-warning .toast-icon {
			color: #ffc107;
		}

		.toast-error .toast-icon {
			color: #dc3545;
		}

		.toast-info .toast-icon {
			color: #17a2b8;
		}

		.toast-message {
			flex: 1;
			font-size: 14px;
			line-height: 1.4;
			color: #333;
			font-weight: 500;
		}

		.toast-close {
			background: none;
			border: none;
			font-size: 16px;
			color: #6c757d;
			cursor: pointer;
			padding: 0;
			width: 20px;
			height: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			transition: background-color 0.2s ease;
		}

		.toast-close:hover {
			background-color: #f8f9fa;
			color: #495057;
		}

		/* Small label styling */
		.form-label.small {
			font-size: 0.875rem;
			margin-bottom: 0.25rem;
		}
	</style>
</head>

<body>
	<main class="container py-4">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h1 class="h4 page-header mb-0" data-translate="pageTitle">Customer Input</h1>
			<div class="language-toggle">
				<button type="button" class="btn btn-outline-primary btn-sm" id="languageToggle">
					<span id="currentLang">English</span>
					<i class="bi bi-translate ms-1"></i>
				</button>
			</div>
		</div>
		<div class="card">
			<div class="card-body">
				<form id="customerForm" novalidate>
					<!-- Service Type -->
					<div class="form-section">
						<button class="btn btn-link p-0 text-decoration-none section-title" type="button"
							data-bs-toggle="collapse" data-bs-target="#secServiceType" aria-expanded="true"
							data-translate="sectionServiceType">Service Type</button>
						<div class="collapse show" id="secServiceType">
							<div class="row g-3 pt-2">
								<div class="col-md-12">
									<label class="form-label" data-translate="serviceTypeLabel">Choose your service type <span class="text-danger">*</span></label>
									<div class="d-flex gap-3">
										<label class="form-check-label">
											<input type="radio" class="form-check-input me-2" name="service-type" value="fulfillment" required>
											<span data-translate="fulfillmentOption">Fulfillment</span>
										</label>
										<label class="form-check-label">
											<input type="radio" class="form-check-input me-2" name="service-type" value="last-mile" required>
											<span data-translate="lastMileOption">Last Mile</span>
										</label>
									</div>
								</div>
							</div>
						</div>
					</div>					  
					<!-- Company & Volumes -->
					<div class="form-section">
						<button class="btn btn-link p-0 text-decoration-none section-title collapsed" type="button"
							data-bs-toggle="collapse" data-bs-target="#secCompany" aria-expanded="false"
							data-translate="sectionCompany">Company & Volumes</button>
						<div class="collapse" id="secCompany">
							<div class="row g-3 pt-2">
								<div class="col-md-6">
									<label class="form-label" data-translate="companyLabel">Customer Company Name <span
											class="text-danger">*</span></label>
									<input type="text" class="form-control" id="company_name" required
										placeholder="Enter company name"
										title="Enter the official company or trade name">
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="weeklyVolumeLabel">Weekly Orders <span class="text-danger">*</span></label>
									<input type="number" min="0" class="form-control" id="weekly_shipments" required
										placeholder="e.g. 5" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="form-text error d-none" id="err_weekly_shipments"
										data-translate="errWeeklyShipments">Must be a number ≥ 0.</div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="weeklyOutboundLabel">Fulfilment Outbound (Unit of Measure: Units)
									<span class="text-danger">*</span></label>
									<input type="number" min="0" class="form-control" id="weekly_units_outbound"
										required placeholder="e.g. 10" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="form-text error d-none" id="err_weekly_units_outbound"
										data-translate="errWeeklyOutbound">Must be a number ≥ 0.</div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="weeklyInboundLabel">Fulfilment Inbound (Unit of Measure: Units)
									<span class="text-danger">*</span></label>
									<input type="number" min="0" class="form-control" id="weekly_units_inbound" required
										placeholder="e.g. 8" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="form-text error d-none" id="err_weeklyInbound">Must be a number ≥ 0.
									</div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="inbound-frequency" class="form-label" data-translate="inboundFrequencyLabel">Frequency of the Inbound</label>
									<select class="form-select" id="inbound-frequency" name="inbound-frequency" required>
										<option value="" data-translate="selectFrequency">Select frequency</option>
										<option value="daily" data-translate="dailyOption">Daily</option>
										<option value="weekly" data-translate="weeklyOption">Weekly</option>
										<option value="biweekly" data-translate="biweeklyOption">Biweekly</option>
									</select>
									<div class="invalid-feedback" id="inbound-frequency-error">
										Please select a frequency.
									</div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="avg-units" class="form-label" data-translate="avgUnitsLabel">Average Unit per Order</label>
									<input type="number" class="form-control" id="avg-units" name="avg-units" min="0" step="0.1" data-translate="avgUnits" required placeholder="e.g. 3" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="invalid-feedback" id="avg-units-error">
										Must be a number ≥ 0.
									</div>
									<div class="form-text error d-none" id="err_avg_units" data-translate="errAvgUnits">Must be a number ≥ 0.</div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="forecastingPeriodLabel">
										<i class="bi bi-calendar me-2"></i>
										Forecasting Period <span class="text-danger">*</span>
									</label>
									<div class="row g-2">
										<div class="col-6">
											<label class="form-label small text-muted" data-translate="startDate">Start
												Date</label>
											<input type="date" class="form-control" id="forecast_start_date" required>
										</div>
										<div class="col-6">
											<label class="form-label small text-muted" data-translate="endDate">End
												Date</label>
											<input type="date" class="form-control" id="forecast_end_date" required>
										</div>
									</div>
									<div class="form-text" data-translate="selectDateRange">Select the date range for
										your forecast</div>
									<div class="form-text error d-none" id="err_forecast_dates"></div>
								</div>
								<div class="col-md-6" id="seasonality_skus_container">
									<label class="form-label" data-translate="skusLabel">Special SKUs for Seasonality
										<small class="text-muted"><em
												data-translate="optionalNote">(optional)</em></small></label>
									<textarea class="form-control" id="seasonality_skus_notes" rows="2"
										placeholder="Optional notes about seasonal SKUs"></textarea>
								</div>
								<div class="col-md-6" id="special_bundles_container">
									<label class="form-label" data-translate="bundlesLabel">Special Bundles
										<small class="text-muted"><em
												data-translate="optionalNote">(optional)</em></small></label>
									<div id="bundles-container">
										<div class="bundle-item mb-2">
											<div class="row g-2">
												<div class="col-5">
													<input type="text" class="form-control bundle-name" data-translate-placeholder="bundleName" placeholder="Bundle Name">
												</div>
												<div class="col-5">
													<input type="text" class="form-control bundle-details" data-translate-placeholder="bundleDetails" placeholder="Bundle Details">
												</div>
												<div class="col-2 d-flex">
													<button type="button" class="btn btn-outline-danger btn-sm remove-bundle" onclick="removeBundle(this)" style="display: none;">
														<i class="bi bi-trash"></i>
													</button>
													<button type="button" class="btn btn-outline-success btn-sm add-bundle" onclick="addBundle()">
														<i class="bi bi-plus"></i>
													</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Payments & Mix -->
					<div class="form-section">
						<button class="btn btn-link p-0 text-decoration-none section-title collapsed" type="button"
							data-bs-toggle="collapse" data-bs-target="#secPayments" aria-expanded="false"
							data-translate="sectionPayments">Payments & Mix</button>
						<div class="collapse" id="secPayments">
							<div class="row g-3 pt-2">
								<div class="col-md-6">
									<label class="form-label" data-translate="codLabel">COD % <span
											class="text-danger">*</span></label>
									<div class="input-group">
										<input type="number" min="0" max="100" class="form-control" id="cod_percent"
											required onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
										<span class="input-group-text">%</span>
									</div>
									<div class="form-text error d-none" id="err_cod_percent"
										data-translate="errCodPercent">Must be between 0 and 100.</div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="ppdLabel">PPD % <span
											class="text-danger">*</span></label>
									<div class="input-group">
										<input type="number" min="0" max="100" class="form-control" id="ppd_percent"
											required onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
										<span class="input-group-text">%</span>
									</div>
									<div class="form-text error d-none" id="err_ppd_percent"
										data-translate="errPpdPercent">Must be between 0 and 100.</div>
									<div class="form-text error d-none" id="err_cod_ppd_sum" data-translate="codPpdSum">
										COD + PPD must equal 100%.</div>
								</div>



								<div class="col-md-12">
									<label class="form-label" data-translate="serviceMixLabel">Service Mix <span class="text-danger">*</span></label>
									<div class="service-mix-container">
										<div class="service-option">
											<input class="form-check-input" type="checkbox" value="hb" id="service_hb" name="service_mix">
											<label class="service-option-label" for="service_hb">
												<div class="service-icon">📦</div>
												<div class="service-text" data-translate="hbOption">Heavy & Bulky</div>
											</label>
										</div>
										<div class="service-option">
											<input class="form-check-input" type="checkbox" value="international" id="service_int" name="service_mix">
											<label class="service-option-label" for="service_int">
												<div class="service-icon">🌍</div>
												<div class="service-text" data-translate="intOption">International</div>
											</label>
										</div>
										<div class="service-option">
											<input class="form-check-input" type="checkbox" value="parcel" id="service_parcel" name="service_mix">
											<label class="service-option-label" for="service_parcel">
												<div class="service-icon">📮</div>
												<div class="service-text" data-translate="parcelOption">Parcel</div>
											</label>
										</div>
									</div>
									<div class="form-text error d-none" id="err_service_mix"
										data-translate="errServiceMix">Please select at least one service mix option.</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Submit -->
					<div class="form-section">
						<div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between">
							<div class="required-note mb-2 mb-sm-0" data-translate="requiredNote"><span
									class="text-danger">*</span> Required fields</div>
							<button type="submit" class="btn btn-primary fw-bold px-4" data-translate="submitButton">[
								Submit ]</button>
						</div>
					</div>

				</form>
			</div>
		</div>
	</main>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="assets/js/supabaseClient.js"></script>
	<script>
		async function main() {
			// Check if Supabase client is available
			if (!window.supa) {
				console.error('Supabase client not found!');
				const lang = translations[currentLanguage];
				showToast(lang.toastDatabaseError, 'error');
				return;
			}
			console.log('Supabase client found:', window.supa);
			
			// Table structure is now known - no need for checking
			console.log('Supabase client ready, table schema confirmed');
			
			// Removed auth guard - customer page is now accessible to everyone

			// Language toggle functionality
			let currentLanguage = 'en'; // Default to English
			const languageToggle = document.getElementById('languageToggle');
			const currentLangSpan = document.getElementById('currentLang');

			// Language translations
			const translations = {
				en: {
					pageTitle: 'Customer\'s forecast questionnaire',
					companyLabel: 'Customer Company Name',
					weeklyVolumeLabel: 'Weekly Orders',
					weeklyOutboundLabel: 'Fulfillment Outbound (Unit of Measure: Units)',
					weeklyInboundLabel: 'Fulfillment Inbound (Unit of Measure: Units)',
					forecastingPeriodLabel: 'Forecasting Period',
					startDate: 'Start Date',
					endDate: 'End Date',
					selectDateRange: 'Select the date range for your forecast',
					skusLabel: 'Special SKUs for Seasonality',
					codLabel: 'COD %',
					ppdLabel: 'PPD %',
					tierSplitLabel: 'Tier Split % (Must sum to 100%)',
					serviceMixLabel: 'Service Mix',
					submitButton: '[ Submit ]',
					requiredNote: 'Required fields',
					optionalNote: '(optional)',
					sectionServiceType: 'Service Type',
					sectionCompany: 'Company & Volume',
					sectionPayments: 'Payments & Mix',
					serviceTypeLabel: 'Select Service Type',
					fulfillmentOption: 'Fulfillment',
					lastMileOption: 'Last Mile',
					bundlesLabel: 'Special Bundles',
					inboundFrequencyLabel: 'Inbound Frequency',
					avgUnitsLabel: 'Average Unit per Order',
					selectFrequency: 'Select frequency',
					dailyOption: 'Daily',
					weeklyOption: 'Weekly',
					biweeklyOption: 'Bi-weekly',
					codPpdSum: 'COD and PPD percentages must sum to 100%.',
					errWeeklyShipments: 'Must be a number ≥ 0.',
					errWeeklyOutbound: 'Must be a number ≥ 0.',
					errWeeklyInbound: 'Must be a number ≥ 0.',
					errCodPercent: 'Must be between 0 and 100.',
					errPpdPercent: 'Must be between 0 and 100.',
					errInboundFrequency: 'Please select a frequency.',
					errAvgUnits: 'Must be a number ≥ 0.',
					errTierSum: 'Tier split percentages must sum to 100%.',
					errServiceMix: 'Please select at least one service mix option.',
					errDatePast: 'Start date cannot be in the past',
					errDateOrder: 'End date must be after start date',
					errDateRange: 'Forecasting period cannot exceed 2 years',
					// Toast notification messages
					toastBundleValidation: 'Please fill in both Bundle Name and Bundle Details before adding a new bundle.',
					toastServiceTypeRequired: 'Please select a service type before submitting the form.',
					toastFormValidation: 'Please fill in all required fields correctly.',
					toastFormSuccess: 'Form submitted successfully! Redirecting...',
					toastFormError: 'Error submitting form: ',
					toastDatabaseError: 'Database connection error. Please refresh the page.',
					placeholder: {
						company: 'Enter company name',
						shipments: 'e.g. 5',
						outbound: 'e.g. 10',
						inbound: 'e.g. 8',
						avgUnits: 'e.g. 3',
						forecastingPeriod: 'Select dates',
						skus: 'Optional notes about seasonal SKUs',
						bundles: 'Optional notes about special bundles',
						bundleName: 'Bundle Name',
						bundleDetails: 'Bundle Details',
						tier0: 'Tier 0 %',
						tier1: 'Tier 1 %',
						tier2: 'Tier 2 %',
						tier3: 'Tier 3 %',
						hb: 'Heavy & Bulky %',
						international: 'International %',
						parcel: 'Parcel %'
					}
				},
				ar: {
					pageTitle: 'استبيان توقعات العملاء',
					companyLabel: 'اسم شركة العميل',
					weeklyVolumeLabel: 'الطلبات الأسبوعية',
					weeklyOutboundLabel: 'الوفاء الصادر (وحدة القياس: وحدات)',
					weeklyInboundLabel: 'الوفاء الوارد (وحدة القياس: وحدات)',
					forecastingPeriodLabel: 'فترة التوقعات',
					startDate: 'تاريخ البداية',
					endDate: 'تاريخ النهاية',
					selectDateRange: 'اختر نطاق التاريخ للتوقعات',
					skusLabel: 'وحدة حفظ المخزون الخاصة للموسمية',
					codLabel: 'نسبة الدفع عند الاستلام %',
					ppdLabel: 'نسبة الدفع المسبق %',
					tierSplitLabel: 'تقسيم المستويات % (يجب أن يكون المجموع 100%)',
					serviceMixLabel: 'مزيج الخدمات',
					submitButton: '[ إرسال ]',
					requiredNote: 'الحقول المطلوبة',
					optionalNote: '(اختياري)',
					sectionServiceType: 'نوع الخدمة',
					sectionCompany: 'الشركة والحجم',
					sectionPayments: 'المدفوعات والمزيج',
					serviceTypeLabel: 'اختر نوع الخدمة',
					fulfillmentOption: 'تخزين',
					lastMileOption: 'الميل الأخير',
					bundlesLabel: 'الحزم الخاصة',
					inboundFrequencyLabel: 'تكرار الواردات',
					avgUnitsLabel: 'متوسط الوحدات لكل طلب',
					selectFrequency: 'اختر التكرار',
					dailyOption: 'يومي',
					weeklyOption: 'أسبوعي',
					biweeklyOption: 'كل أسبوعين',
					codPpdSum: 'يجب أن يكون مجموع نسبة الدفع عند الاستلام ونسبة الدفع المسبق 100%.',
					errWeeklyShipments: 'يجب أن يكون رقماً ≥ 0.',
					errWeeklyOutbound: 'يجب أن يكون رقماً ≥ 0.',
					errWeeklyInbound: 'يجب أن يكون رقماً ≥ 0.',
					errCodPercent: 'يجب أن يكون بين 0 و 100.',
					errPpdPercent: 'يجب أن يكون بين 0 و 100.',
					errInboundFrequency: 'يرجى اختيار التكرار.',
					errAvgUnits: 'يجب أن يكون رقماً ≥ 0.',
					errTierSum: 'يجب أن يكون مجموع تقسيم المستويات 100%.',
					errServiceMix: 'يرجى اختيار خيار واحد على الأقل من مزيج الخدمات.',
					errDatePast: 'لا يمكن أن يكون تاريخ البداية في الماضي',
					errDateOrder: 'يجب أن يكون تاريخ النهاية بعد تاريخ البداية',
					errDateRange: 'لا يمكن أن تتجاوز فترة التوقعات سنتين',
					// Toast notification messages
					toastBundleValidation: 'يرجى ملء اسم الحزمة وتفاصيل الحزمة قبل إضافة حزمة جديدة.',
					toastServiceTypeRequired: 'يرجى اختيار نوع الخدمة قبل إرسال النموذج.',
					toastFormValidation: 'يرجى ملء جميع الحقول المطلوبة بشكل صحيح.',
					toastFormSuccess: 'تم إرسال النموذج بنجاح! جاري إعادة التوجيه...',
					toastFormError: 'خطأ في إرسال النموذج: ',
					toastDatabaseError: 'خطأ في الاتصال بقاعدة البيانات. يرجى تحديث الصفحة.',
					placeholder: {
						company: 'أدخل اسم الشركة',
						shipments: 'مثال: 5',
						outbound: 'مثال: 10',
						inbound: 'e.g. 8',
						avgUnits: 'e.g. 3',
						forecastingPeriod: 'اختر التواريخ',
						skus: 'ملاحظات اختيارية حول وحدة حفظ المخزون الموسمية',
						bundles: 'ملاحظات اختيارية حول الحزم الخاصة',
						bundleName: 'اسم الحزمة',
						bundleDetails: 'تفاصيل الحزمة',
						tier0: 'المستوى 0 %',
						tier1: 'المستوى 1 %',
						tier2: 'المستوى 2 %',
						tier3: 'المستوى 3 %',
						hb: 'ثقيل و متين %',
						international: 'دولي %',
						parcel: 'طرد %'
					},
					hbOption: 'ثقيل و متين',
					intOption: 'دولي',
					parcelOption: 'طرد'
				}
			};

			// Function to update form language
			function updateFormLanguage() {
				const lang = translations[currentLanguage];

				// Update all elements with data-translate attribute
				document.querySelectorAll('[data-translate]').forEach(element => {
					const key = element.getAttribute('data-translate');
					if (lang[key]) {
						if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
							// For input elements, update placeholder
							element.placeholder = lang[key];
						} else {
							// For other elements, update text content
							if (key === 'companyLabel' || key === 'weeklyVolumeLabel' || key === 'weeklyOutboundLabel' ||
								key === 'weeklyInboundLabel' || key === 'inboundFrequencyLabel' || key === 'avgUnitsLabel' || key === 'forecastingPeriodLabel' || key === 'codLabel' ||
								key === 'ppdLabel' ||
								key === 'serviceMixLabel') {
								element.innerHTML = lang[key] + ' <span class="text-danger">*</span>';
							} else if (key === 'skusLabel' || key === 'bundlesLabel') {
								element.innerHTML = lang[key] + ' <small class="text-muted"><em>' + lang.optionalNote + '</em></small>';
							} else if (key === 'requiredNote') {
								element.innerHTML = '<span class="text-danger">*</span> ' + lang[key];
							} else {
								element.textContent = lang[key];
							}
						}
					}
				});

				// Update placeholders using data-translate-placeholder attribute
				document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
					const key = element.getAttribute('data-translate-placeholder');
					if (lang.placeholder && lang.placeholder[key]) {
						element.placeholder = lang.placeholder[key];
					}
				});
			}

			// Load saved language preference
			const savedLanguage = localStorage.getItem('customerFormLanguage');
			if (savedLanguage && (savedLanguage === 'en' || savedLanguage === 'ar')) {
				currentLanguage = savedLanguage;
				updateFormLanguage();
			}

			// Add event listener for language toggle button
			languageToggle.addEventListener('click', function() {
				// Toggle between English and Arabic
				currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
				
				// Save language preference
				localStorage.setItem('customerFormLanguage', currentLanguage);
				
				// Update form language
				updateFormLanguage();
				
				// Update button text
				currentLangSpan.textContent = currentLanguage === 'en' ? 'English' : 'العربية';
			});

			// Function to handle service type changes
			function handleServiceTypeChange() {
				const serviceTypeRadios = document.querySelectorAll('input[name="service-type"]');
				const seasonalityContainer = document.getElementById('seasonality_skus_container');
				const bundlesContainer = document.getElementById('special_bundles_container');
				
				// Initially hide both containers
				if (seasonalityContainer) seasonalityContainer.style.display = 'none';
				if (bundlesContainer) bundlesContainer.style.display = 'none';
				
				serviceTypeRadios.forEach(radio => {
					radio.addEventListener('change', function() {
						if (this.value === 'fulfillment') {
							// Show both fields for fulfillment
							if (seasonalityContainer) seasonalityContainer.style.display = 'block';
							if (bundlesContainer) bundlesContainer.style.display = 'block';
						} else if (this.value === 'last-mile') {
							// Hide both fields for last mile
							if (seasonalityContainer) seasonalityContainer.style.display = 'none';
							if (bundlesContainer) bundlesContainer.style.display = 'none';
						}
					});
				});
				
				// Check initial state
				const checkedRadio = document.querySelector('input[name="service-type"]:checked');
				if (checkedRadio) {
					if (checkedRadio.value === 'fulfillment') {
						if (seasonalityContainer) seasonalityContainer.style.display = 'block';
						if (bundlesContainer) bundlesContainer.style.display = 'block';
					}
				}
			}

			// Format dates for input fields (YYYY-MM-DD)
			const formatDate = (date) => {
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				return `${year}-${month}-${day}`;
			};

			// Set default dates for forecasting period
			const today = new Date();
			const tomorrow = new Date();
			const threeMonthsLater = new Date();
			tomorrow.setDate(today.getDate() + 1); // Start from tomorrow
			threeMonthsLater.setMonth(tomorrow.getMonth() + 3);

			// Set initial dates and constraints
			const forecastStartDate = document.getElementById('forecast_start_date');
			const forecastEndDate = document.getElementById('forecast_end_date');

			// Set minimum date to today for start date
			forecastStartDate.min = formatDate(today);
			forecastStartDate.value = formatDate(tomorrow);
			forecastEndDate.value = formatDate(threeMonthsLater);

			const form = document.getElementById('customerForm');
			const company = document.getElementById('company_name');
			const weeklyShip = document.getElementById('weekly_shipments');
			const weeklyOut = document.getElementById('weekly_units_outbound');
			const weeklyIn = document.getElementById('weekly_units_inbound');
			const inboundFreq = document.getElementById('inbound-frequency');
			const avgUnits = document.getElementById('avg-units');
			const notes = document.getElementById('seasonality_skus_notes');
			const bundlesNotes = document.getElementById('special_bundles_notes');
			const serviceType = document.querySelector('input[name="service-type"]:checked');
			const cod = document.getElementById('cod_percent');
			const ppd = document.getElementById('ppd_percent');

			function show(el, flag) { if (!el) return; el.classList[flag ? 'remove' : 'add']('d-none'); }

			function showError(messageKey) {
				const errorElement = document.getElementById('err_forecast_dates');
				if (errorElement) {
					const lang = translations[currentLanguage];
					errorElement.textContent = lang[messageKey] || messageKey;
					errorElement.classList.remove('d-none');
				}
			}
			function validateNumericInput(input, errorElement, min = 0, max = null) {
				if (!input || !errorElement) {
					console.warn('validateNumericInput: missing input or errorElement');
					return false;
				}
				const value = parseFloat(input.value);
				if (isNaN(value) || value < min || (max !== null && value > max)) {
					input.classList.add('is-invalid');
					errorElement.classList.remove('d-none');
					return false;
				}
				input.classList.remove('is-invalid');
				errorElement.classList.add('d-none');
				return true;
			}

			function validateInboundFrequency() {
				const select = document.getElementById('inbound-frequency');
				const errorElement = document.getElementById('inbound-frequency-error');
				
				if (!select.value) {
					select.classList.add('is-invalid');
					errorElement.textContent = translations[currentLanguage].errInboundFrequency;
					return false;
				}
				
				select.classList.remove('is-invalid');
				return true;
			}

			function validateAvgUnits() {
				const input = document.getElementById('avg-units');
				const errorElement = document.getElementById('avg-units-error');
				
				const value = parseFloat(input.value);
				if (isNaN(value) || value < 0) {
					input.classList.add('is-invalid');
					errorElement.textContent = translations[currentLanguage].errAvgUnits;
					return false;
				}
				
				input.classList.remove('is-invalid');
				return true;
			}

			// Add missing validateSum100 function
			function validateSum100(inputs, errorElement) {
				const sum = inputs.reduce((total, input) => {
					const value = parseFloat(input.value) || 0;
					return total + value;
				}, 0);
				
				if (Math.abs(sum - 100) > 0.01) { // Allow small floating point differences
					inputs.forEach(input => input.classList.add('is-invalid'));
					errorElement.classList.remove('d-none');
					return false;
				}
				
				inputs.forEach(input => input.classList.remove('is-invalid'));
				errorElement.classList.add('d-none');
				return true;
			}

			// Date validation function for form submission
			function validateDateRange() {
				if (forecastStartDate.value && forecastEndDate.value) {
					const startDate = new Date(forecastStartDate.value);
					const endDate = new Date(forecastEndDate.value);
					return endDate > startDate;
				}
				return false;
			}
			['input', 'change'].forEach(evt => { cod.addEventListener(evt, validateCodPpd); ppd.addEventListener(evt, validateCodPpd); });
			function validateCodPpd() { const codValid = validateNumericInput(cod, document.getElementById('err_cod_percent'), 0, 100); const ppdValid = validateNumericInput(ppd, document.getElementById('err_ppd_percent'), 0, 100); const sumOk = validateNumericInput(cod, document.getElementById('err_cod_ppd_sum'), 0, 100) && validateNumericInput(ppd, document.getElementById('err_cod_ppd_sum'), 0, 100) && parseFloat(cod.value) + parseFloat(ppd.value) === 100; return codValid && ppdValid && sumOk; }
			function validateForecastDates() {
				const startDate = new Date(forecastStartDate.value);
				const endDate = new Date(forecastEndDate.value);
				const today = new Date();
				today.setHours(0, 0, 0, 0); // Reset time for accurate comparison

				// Reset any existing error and styling
				const errorElement = document.getElementById('err_forecast_dates');
				if (errorElement) errorElement.classList.add('d-none');
				forecastStartDate.classList.remove('is-invalid');
				forecastEndDate.classList.remove('is-invalid');

				// Check if dates are selected
				if (!forecastStartDate.value || !forecastEndDate.value) {
					if (!forecastStartDate.value) forecastStartDate.classList.add('is-invalid');
					if (!forecastEndDate.value) forecastEndDate.classList.add('is-invalid');
					return false;
				}

				// Check if start date is not in the past
				startDate.setHours(0, 0, 0, 0);
				if (startDate < today) {
					showError('errDatePast');
					forecastStartDate.classList.add('is-invalid');
					return false;
				}

				// Check if end date is after start date (not same day or before)
				endDate.setHours(0, 0, 0, 0);
				if (endDate <= startDate) {
					showError('errDateOrder');
					forecastEndDate.classList.add('is-invalid');
					forecastStartDate.classList.add('is-invalid');
					return false;
				}

				// Check if period is not too long (max 2 years)
				const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
				if (daysDiff > 730) {
					showError('errDateRange');
					forecastEndDate.classList.add('is-invalid');
					return false;
				}

				return true;
			}

			// Date validation function for form submission
			function validateDateRange() {
				if (forecastStartDate.value && forecastEndDate.value) {
					const startDate = new Date(forecastStartDate.value);
					const endDate = new Date(forecastEndDate.value);
					return endDate > startDate;
				}
				return false;
			}
			['input', 'change'].forEach(evt => { cod.addEventListener(evt, validateCodPpd); ppd.addEventListener(evt, validateCodPpd); });
			validateCodPpd();
			// Add event listeners for percentage inputs to prevent negative values and values over 100
			[cod, ppd].forEach(input => {
				input.addEventListener('input', function() {
					// Prevent negative values
					if (this.value < 0) this.value = 0;
					// Prevent values over 100 for percentage fields
					if (this.value > 100) this.value = 100;
				});
			});
			const weeklyShipmentsInput = document.getElementById('weekly_shipments');
			const weeklyOutboundInput = document.getElementById('weekly_units_outbound');
			const weeklyInboundInput = document.getElementById('weekly_units_inbound');
			const inboundFrequencySelect = document.getElementById('inbound-frequency');
			const avgUnitsInput = document.getElementById('avg-units');

			weeklyShipmentsInput.addEventListener('input', () => {
				// Prevent negative values
				if (weeklyShipmentsInput.value < 0) weeklyShipmentsInput.value = 0;
				validateNumericInput(weeklyShipmentsInput, document.getElementById('err_weekly_shipments'));
			});
			weeklyOutboundInput.addEventListener('input', () => {
				// Prevent negative values
				if (weeklyOutboundInput.value < 0) weeklyOutboundInput.value = 0;
				validateNumericInput(weeklyOutboundInput, document.getElementById('err_weekly_units_outbound'));
			});
			weeklyInboundInput.addEventListener('input', () => {
				// Prevent negative values
				if (weeklyInboundInput.value < 0) weeklyInboundInput.value = 0;
				validateNumericInput(weeklyInboundInput, document.getElementById('err_weeklyInbound'));
			});

			inboundFrequencySelect.addEventListener('change', validateInboundFrequency);
			avgUnitsInput.addEventListener('input', () => {
				// Prevent negative values
				if (avgUnitsInput.value < 0) avgUnitsInput.value = 0;
				validateAvgUnits();
			});

			function validateServiceType() {
				const selectedServiceType = document.querySelector('input[name="service-type"]:checked');
				if (!selectedServiceType) {
					// Add visual feedback for missing service type selection
					const serviceTypeContainer = document.querySelector('.d-flex.gap-3');
					if (serviceTypeContainer) {
						serviceTypeContainer.classList.add('border', 'border-danger', 'rounded', 'p-2');
					}
					return false;
				} else {
					// Remove error styling if service type is selected
					const serviceTypeContainer = document.querySelector('.d-flex.gap-3');
					if (serviceTypeContainer) {
						serviceTypeContainer.classList.remove('border', 'border-danger', 'rounded', 'p-2');
					}
					return true;
				}
			}

			// Add event listeners for service type radio buttons
			document.querySelectorAll('input[name="service-type"]').forEach(radio => {
				radio.addEventListener('change', validateServiceType);
			});

			// Enhanced input sanitization for company name
			const companyNameInput = document.getElementById('company_name');
			companyNameInput.addEventListener('input', function() {
				// Remove leading/trailing spaces and limit length
				this.value = this.value.trim().substring(0, 100);
			});

			// Enhanced date validation with event listeners
			function updateDateConstraints() {
    if (forecastStartDate.value) {
        // Set end date min to start date + 1 day
        const startDate = new Date(forecastStartDate.value);
        startDate.setDate(startDate.getDate() + 1);
        forecastEndDate.min = formatDate(startDate);

					// If end date is now invalid, suggest a new date
					if (forecastEndDate.value && forecastEndDate.value <= forecastStartDate.value) {
						// Auto-suggest end date 3 months after start date
						const suggestedEndDate = new Date(forecastStartDate.value);
						suggestedEndDate.setMonth(suggestedEndDate.getMonth() + 3);
						forecastEndDate.value = formatDate(suggestedEndDate);
					}
				}
			}

			forecastStartDate.addEventListener('change', () => {
				updateDateConstraints();
				validateForecastDates();
			});

			forecastStartDate.addEventListener('input', () => {
				updateDateConstraints();
				validateForecastDates();
			});

			forecastEndDate.addEventListener('change', () => {
				validateForecastDates();
			});

			forecastEndDate.addEventListener('input', () => {
				validateForecastDates();
			});

			// Real-time validation on blur for better UX
			forecastStartDate.addEventListener('blur', () => {
				validateForecastDates();
			});

			forecastEndDate.addEventListener('blur', () => {
				validateForecastDates();
			});

			// Initialize date constraints on page load
			updateDateConstraints();

			// Add visual validation indicators
			forecastStartDate.classList.add('date-input');
			forecastEndDate.classList.add('date-input');

			// Service Mix validation and helper functions
			function validateServiceMix() {
				const serviceMixCheckboxes = document.querySelectorAll('input[name="service_mix"]:checked');
				const errorElement = document.getElementById('err_service_mix');
				
				if (serviceMixCheckboxes.length === 0) {
					// Show error if no service mix is selected
					if (errorElement) errorElement.classList.remove('d-none');
					serviceMixCheckboxes.forEach(cb => cb.closest('.service-option').classList.add('border-danger'));
					return false;
				} else {
					// Hide error if at least one service mix is selected
					if (errorElement) errorElement.classList.add('d-none');
					document.querySelectorAll('.service-option').forEach(option => option.classList.remove('border-danger'));
					return true;
				}
			}

			function getSelectedServiceMix() {
				const serviceMixCheckboxes = document.querySelectorAll('input[name="service_mix"]:checked');
				return Array.from(serviceMixCheckboxes).map(cb => cb.value).join(',');
			}

			// Bundle management functions (global scope)
			function addBundle() {
				// Check if the last bundle has both fields filled
				const bundleItems = document.querySelectorAll('.bundle-item');
				if (bundleItems.length > 0) {
					const lastBundle = bundleItems[bundleItems.length - 1];
					const lastBundleName = lastBundle.querySelector('.bundle-name').value.trim();
					const lastBundleDetails = lastBundle.querySelector('.bundle-details').value.trim();
					
					if (lastBundleName === '' || lastBundleDetails === '') {
						const lang = translations[currentLanguage];
						showToast(lang.toastBundleValidation, 'warning');
						return;
					}
				}
				
				const container = document.getElementById('bundles-container');
				const bundleItem = document.createElement('div');
				bundleItem.className = 'bundle-item mb-2';
				bundleItem.innerHTML = `
					<div class="row g-2">
						<div class="col-5">
							<input type="text" class="form-control bundle-name" data-translate-placeholder="bundleName" placeholder="${translations[currentLanguage].placeholder.bundleName}">
						</div>
						<div class="col-5">
							<input type="text" class="form-control bundle-details" data-translate-placeholder="bundleDetails" placeholder="${translations[currentLanguage].placeholder.bundleDetails}">
						</div>
						<div class="col-2 d-flex">
							<button type="button" class="btn btn-outline-danger btn-sm remove-bundle" onclick="removeBundle(this)">
								<i class="bi bi-trash"></i>
							</button>
							<button type="button" class="btn btn-outline-success btn-sm add-bundle" onclick="addBundle()">
								<i class="bi bi-plus"></i>
							</button>
						</div>
					</div>
				`;
				container.appendChild(bundleItem);
				updateBundleButtons();
			}
			
			function removeBundle(button) {
				const bundleItem = button.closest('.bundle-item');
				bundleItem.remove();
				updateBundleButtons();
			}
			
			function updateBundleButtons() {
				const bundleItems = document.querySelectorAll('.bundle-item');
				const addButtons = document.querySelectorAll('.add-bundle');
				const removeButtons = document.querySelectorAll('.remove-bundle');
				
				// Hide all add buttons except the last one
				addButtons.forEach((btn, index) => {
					btn.style.display = index === bundleItems.length - 1 ? 'block' : 'none';
				});
				
				// Show remove buttons only if there's more than one bundle
				removeButtons.forEach(btn => {
					btn.style.display = bundleItems.length > 1 ? 'block' : 'none';
				});
			}
			
			// Toast notification function
			function showToast(message, type = 'info') {
				// Remove existing toast if any
				const existingToast = document.querySelector('.custom-toast');
				if (existingToast) {
					existingToast.remove();
				}
				
				// Create toast element
				const toast = document.createElement('div');
				toast.className = `custom-toast toast-${type}`;
				
				// Set icon based on type
				let icon = '';
				switch(type) {
					case 'success': icon = '<i class="bi bi-check-circle-fill"></i>'; break;
					case 'warning': icon = '<i class="bi bi-exclamation-triangle-fill"></i>'; break;
					case 'error': icon = '<i class="bi bi-x-circle-fill"></i>'; break;
					default: icon = '<i class="bi bi-info-circle-fill"></i>'; break;
				}
				
				toast.innerHTML = `
					<div class="toast-content">
						<div class="toast-icon">${icon}</div>
						<div class="toast-message">${message}</div>
						<button class="toast-close" onclick="this.parentElement.parentElement.remove()">
							<i class="bi bi-x"></i>
						</button>
					</div>
				`;
				
				// Add to page
				document.body.appendChild(toast);
				
				// Show with animation
				setTimeout(() => toast.classList.add('show'), 100);
				
				// Auto remove after 5 seconds
				setTimeout(() => {
					if (toast.parentElement) {
						toast.classList.remove('show');
						setTimeout(() => toast.remove(), 300);
					}
				}, 5000);
			}
			
			// Make functions global
			window.addBundle = addBundle;
			window.removeBundle = removeBundle;
			window.showToast = showToast;
			
			// Initialize bundle buttons
			updateBundleButtons();
			
			// Initialize service type change handling
			handleServiceTypeChange();
			
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				console.log('Form submitted, starting validation...');

			
				// Date validation
				if (!validateForecastDates()) {
					console.log('Date validation failed');
					return;
				}
				console.log('Date validation passed');

				// Check each validation step
				console.log('Company name:', company.value.trim().length > 0);
				console.log('Weekly shipments:', weeklyShip.value && !isNaN(weeklyShip.value) && Number(weeklyShip.value) >= 0);
				console.log('Weekly outbound:', weeklyOut.value && !isNaN(weeklyOut.value) && Number(weeklyOut.value) >= 0);
				console.log('Weekly inbound:', weeklyIn.value && !isNaN(weeklyIn.value) && Number(weeklyIn.value) >= 0);
				console.log('Inbound frequency:', inboundFreq.value);
				console.log('Date validation:', validateForecastDates());
				console.log('COD/PPD validation:', validateCodPpd());

				const isValidCompany = company.value.trim().length > 0;
				const isValidShipments = weeklyShip.value && !isNaN(weeklyShip.value) && Number(weeklyShip.value) >= 0;
				const isValidOutbound = weeklyOut.value && !isNaN(weeklyOut.value) && Number(weeklyOut.value) >= 0;
				const isValidInbound = weeklyIn.value && !isNaN(weeklyIn.value) && Number(weeklyIn.value) >= 0;
				const isValidInboundFreq = inboundFreq.value;
				const isValidAvgUnits = validateAvgUnits();
				const isValidServiceType = validateServiceType();
				const isValidCodPpd = validateCodPpd();
				const isValidTierSplit = true; // Tier split removed
				const isValidServiceMix = validateServiceMix();
				const isValidDates = validateForecastDates();

				const valid = (isValidCompany && isValidShipments && isValidOutbound && isValidInbound && isValidInboundFreq && isValidAvgUnits && isValidServiceType && isValidCodPpd && isValidServiceMix && isValidDates);
				
				if (!valid) {
					console.log('Form validation failed, cannot submit');
					return;
				}

				console.log('All validations passed, submitting form...');
				// Create submission matching the exact Supabase table schema
				const selectedServiceType = document.querySelector('input[name="service-type"]:checked');
				
				// Collect bundle data from the form
				const collectBundleData = () => {
					const bundleItems = document.querySelectorAll('.bundle-item');
					const bundles = [];
					bundleItems.forEach(item => {
						const nameInput = item.querySelector('.bundle-name');
						const detailsInput = item.querySelector('.bundle-details');
						if (nameInput && detailsInput) {
							const name = nameInput.value.trim();
							const details = detailsInput.value.trim();
							if (name || details) { // Only add if there's some content
								bundles.push({ name, details });
							}
						}
					});
					return bundles;
				};
				
				const newSubmission = {
					company_name: company.value.trim(),
					service_type: selectedServiceType ? selectedServiceType.value : null,
					weekly_shipments: Number(weeklyShip.value),
					weekly_units_outbound: Number(weeklyOut.value),
					weekly_units_inbound: Number(weeklyIn.value),
					forecast_start_date: forecastStartDate.value,
					forecast_end_date: forecastEndDate.value,
					seasonality_skus_notes: notes.value.trim(),
					special_bundles: JSON.stringify(collectBundleData()),
					special_bundles_notes: bundlesNotes ? bundlesNotes.value.trim() : '',
					inbound_frequency: inboundFreq.value,
					avg_units_per_shipment: Number(avgUnits.value),
					cod_percent: Number(cod.value),
					ppd_percent: Number(ppd.value),
					service_mix: getSelectedServiceMix()
				};
				try {
					console.log('Submitting to Supabase:', newSubmission);
					const { data, error } = await window.supa.from('submissions').insert([newSubmission]);
					if (error) throw error;
					console.log('Data submitted successfully:', data);
					
					// Pass language preference to thank you page
					const thankYouUrl = currentLanguage === 'ar' ? 'thank-you.html?lang=ar' : 'thank-you.html?lang=en';
					const lang = translations[currentLanguage];
					showToast(lang.toastFormSuccess, 'success');
					setTimeout(() => {
						window.location.href = 'thank-you.html';
					}, 2000);
				} catch (err) {
					console.error('Error submitting data:', err);
					const lang = translations[currentLanguage];
					showToast(lang.toastFormError + err.message, 'error');
					
					// Even if database submission fails, redirect to thank you page
					// This ensures users don't get stuck on the form
					console.log('Database submission failed, but redirecting to thank you page...');
					setTimeout(() => {
						window.location.href = 'thank-you.html';
					}, 2000);
					window.location.href = thankYouUrl;
				}
			});
		}
		main();
	</script>
</body>

</html>