<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Customer Input</title>
	<link rel="icon" type="image/png" href="favicon.png">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/styles.css">
	<style>
		/* Date input styling */
		input[type="date"] {
			font-family: inherit;
			font-size: 14px;
			position: relative;
		}

		/* Date input styling */
		input[type="date"] {
			font-family: inherit;
			font-size: 14px;
		}

		/* Date validation styling */
		.date-input.is-invalid {
			border-color: #dc3545 !important;
			box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
		}

		.date-input.is-invalid:focus {
			border-color: #dc3545 !important;
			box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
		}

		.date-input {
			border: 2px solid #e0e0e0;
			transition: border-color 0.3s ease;
		}

		.date-input:focus {
			border-color: #1f6a4a;
			box-shadow: 0 0 0 0.2rem rgba(31, 106, 74, 0.25);
		}

		/* RTL Support for Arabic */
		[dir="rtl"] {
			text-align: right;
		}
		
		[dir="rtl"] .form-control,
		[dir="rtl"] .form-select {
			text-align: right;
		}
		
		[dir="rtl"] .service-option-label {
			text-align: center;
		}
		
		[dir="rtl"] .service-section-header h6 {
			text-align: center;
		}

		/* Service Mix Styles */
		.service-mix-container {
			display: block;
			margin-top: 0.5rem;
		}
		
		.service-option {
			position: relative;
			margin-bottom: 15px;
		}
		
		.service-option-with-details {
			width: 100%;
			margin-bottom: 25px;
		}
		
		.service-option-with-details.active {
			border-color: #1f6a4a;
			box-shadow: 0 0 0 0.25rem rgba(31, 106, 74, 0.25);
		}
		
		.service-details {
			margin-top: 15px;
			padding: 20px;
			border: 1px solid #dee2e6;
			border-radius: 8px;
			background-color: #f8f9fa;
			margin-left: 20px;
			margin-right: 20px;
		}
		
		.service-option input[type="checkbox"] {
			position: absolute;
			opacity: 0;
			width: 0;
			height: 0;
		}
		
		.service-option-label {
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 1.5rem 1rem;
			border: 2px solid #e9ecef;
			border-radius: 12px;
			background: #fff;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: center;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}
		
		.service-option-label:hover {
			border-color: #1f6a4a;
			box-shadow: 0 4px 12px rgba(31, 106, 74, 0.15);
			transform: translateY(-2px);
		}
		
		.service-option input:checked + .service-option-label {
			border-color: #1f6a4a;
			background: #1f6a4a;
			color: white;
			box-shadow: 0 6px 20px rgba(31, 106, 74, 0.3);
			transform: translateY(-3px);
		}
		
		.service-icon {
			font-size: 2rem;
			margin-bottom: 0.5rem;
			opacity: 0.8;
		}
		
		.service-option input:checked + .service-option-label .service-icon {
			opacity: 1;
			transform: scale(1.1);
		}
		
		.service-text {
			font-weight: 500;
			font-size: 0.95rem;
			line-height: 1.3;
		}
		
		@media (max-width: 768px) {
			.service-option-label {
				flex-direction: row;
				text-align: left;
				padding: 1rem;
			}
			
			.service-icon {
				margin-bottom: 0;
				margin-right: 0.75rem;
				font-size: 1.5rem;
			}
			
			.service-details {
				margin-left: 0;
				margin-right: 0;
				padding: 15px;
			}
		}

		/* Custom Toast Styles */
		.custom-toast {
			position: fixed;
			top: 20px;
			right: 20px;
			min-width: 300px;
			max-width: 400px;
			background: white;
			border-radius: 12px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
			z-index: 9999;
			transform: translateX(100%);
			transition: transform 0.3s ease, opacity 0.3s ease;
			opacity: 0;
			border-left: 4px solid #6c757d;
		}

		.custom-toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		.custom-toast.toast-success {
			border-left-color: #28a745;
		}

		.custom-toast.toast-warning {
			border-left-color: #ffc107;
		}

		.custom-toast.toast-error {
			border-left-color: #dc3545;
		}

		.custom-toast.toast-info {
			border-left-color: #17a2b8;
		}

		.toast-content {
			display: flex;
			align-items: flex-start;
			padding: 16px;
			gap: 12px;
		}

		.toast-icon {
			font-size: 20px;
			margin-top: 2px;
		}

		.toast-success .toast-icon {
			color: #28a745;
		}

		.toast-warning .toast-icon {
			color: #ffc107;
		}

		.toast-error .toast-icon {
			color: #dc3545;
		}

		.toast-info .toast-icon {
			color: #17a2b8;
		}

		.toast-message {
			flex: 1;
			font-size: 14px;
			line-height: 1.4;
			color: #333;
			font-weight: 500;
		}

		.toast-close {
			background: none;
			border: none;
			font-size: 16px;
			color: #6c757d;
			cursor: pointer;
			padding: 0;
			width: 20px;
			height: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			transition: background-color 0.2s ease;
		}

		.toast-close:hover {
			background-color: #f8f9fa;
			color: #495057;
		}

		/* Small label styling */
		.form-label.small {
			font-size: 0.875rem;
			margin-bottom: 0.25rem;
		}
	</style>
</head>

<body>
	<main class="container py-4">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h1 class="h4 page-header mb-0" data-translate="pageTitle">Customer Input</h1>
			<div class="language-toggle">
				<button type="button" class="btn btn-outline-primary btn-sm" id="languageToggle">
					<span id="currentLang">English</span>
					<i class="bi bi-translate ms-1"></i>
				</button>
			</div>
		</div>
		<div class="card">
			<div class="card-body">
				<form id="customerForm" novalidate>
					<!-- Product Type -->
					<div class="form-section">
						<button class="btn btn-link p-0 text-decoration-none section-title" type="button"
							data-bs-toggle="collapse" data-bs-target="#secServiceType" aria-expanded="true"
							data-translate="sectionServiceType">Product Type</button>
						<div class="collapse show" id="secServiceType">
							<div class="row g-3 pt-2">
								<div class="col-md-12">
									<label class="form-label" data-translate="serviceTypeLabel">Choose your product type <span class="text-danger">*</span></label>
									<div class="d-flex gap-3">
										<label class="form-check-label">
											<input type="radio" class="form-check-input me-2" name="service-type" value="fulfillment" required>
											<span data-translate="fulfillmentOption">Fulfillment</span>
										</label>
										<label class="form-check-label">
											<input type="radio" class="form-check-input me-2" name="service-type" value="last-mile" required>
											<span data-translate="lastMileOption">Last Mile</span>
										</label>
										<label class="form-check-label">
											<input type="radio" class="form-check-input me-2" name="service-type" value="fulfillment-and-last-mile" required>
											<span data-translate="fulfillmentAndLastMileOption">Fulfillment and Last Mile</span>
										</label>
									</div>
									<div class="form-text error d-none" id="err_service_type"
										data-translate="errServiceType">Please select a product type.</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Last Mile Service Structure -->
					<div class="form-section">
						<button class="btn btn-link p-0 text-decoration-none section-title collapsed" type="button"
							data-bs-toggle="collapse" data-bs-target="#secPayments" aria-expanded="false"
							data-translate="sectionPayments">Last Mile Service Structure</button>
						<div class="collapse" id="secPayments">
							<div class="row g-3 pt-2">
								<!-- Service Mix Selection with Nested Service Details -->
								<div class="col-md-12">
									<label class="form-label" data-translate="lastMileServiceMixLabel">Last Mile Service Mix <span class="text-danger">*</span></label>
									<div class="service-mix-container">
										<!-- Parcel Service Option with Details -->
										<div class="service-option service-option-with-details">
											<input class="form-check-input" type="checkbox" value="parcel" id="service_parcel" name="lastmile_service_mix">
											<label class="service-option-label" for="service_parcel">
												<div class="service-icon">📦</div>
												<div class="service-text" data-translate="parcelOption">Parcels</div>
											</label>
											
											<!-- Parcel Service Details Section -->
											<div class="service-details d-none" id="parcel_service_section">
												<div class="service-section-header">
													<h6 class="mb-3" data-translate="parcelServiceTitle">Parcel Service Details</h6>
												</div>
												<div class="row g-3">
													<div class="col-md-6">
														<label class="form-label" data-translate="pickupFrequencyLabel">Pickup Frequency <span class="text-danger">*</span></label>
														<select class="form-select" id="parcel_pickup_frequency">
															<option value="" data-translate="selectFrequency">Select frequency</option>
															<option value="once" data-translate="onceDaily">Once a Day</option>
															<option value="twice" data-translate="twiceDaily">Twice a Day</option>
														</select>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="timeSlotLabel">Time Slot(s) <span class="text-danger">*</span></label>
														<div class="row g-2" id="parcel_time_slot_container">
															<!-- Dynamic time slots will be generated here -->
														</div>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="cityLabel">City <span class="text-danger">*</span></label>
														<select class="form-select" id="parcel_city">
															<option value="" data-translate="selectCity">Select city</option>
															<option value="dammam" data-translate="dammamOption">Dammam</option>
															<option value="riyadh" data-translate="riyadhOption">Riyadh</option>
															<option value="jeddah" data-translate="jeddahOption">Jeddah</option>
														</select>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="districtLabel">District <span class="text-danger">*</span></label>
														<input type="text" class="form-control" id="parcel_district" placeholder="Enter district" data-translate-placeholder="enterDistrict">
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="weeklyShipmentsLabel">Weekly Shipments <span class="text-danger">*</span></label>
														<input type="number" min="0" class="form-control" id="parcel_weekly_shipments" placeholder="e.g. 100" data-translate-placeholder="exampleShipments">
													</div>
													<div class="col-md-3">
														<label class="form-label" data-translate="codLabel">Cash on Delivery % <span class="text-danger">*</span></label>
														<div class="input-group">
															<input type="number" min="0" max="100" class="form-control" id="parcel_cod_percent">
															<span class="input-group-text">%</span>
														</div>
													</div>
													<div class="col-md-3">
														<label class="form-label" data-translate="ppdLabel">Pre Paid % <span class="text-danger">*</span></label>
														<div class="input-group">
															<input type="number" min="0" max="100" class="form-control" id="parcel_ppd_percent">
															<span class="input-group-text">%</span>
														</div>
														<div class="form-text error d-none" id="err_parcel_payment" data-translate="codPpdSum">
															COD + PPD must equal 100%.
														</div>
													</div>
												</div>
											</div>
										</div>
										
										<!-- Heavy & Bulky Service Option with Details -->
										<div class="service-option service-option-with-details">
											<input class="form-check-input" type="checkbox" value="hb" id="service_hb" name="lastmile_service_mix">
											<label class="service-option-label" for="service_hb">
												<div class="service-icon">🚛</div>
												<div class="service-text" data-translate="hbOption">Heavy & Bulky</div>
											</label>
											
											<!-- Heavy & Bulky Service Details Section -->
											<div class="service-details d-none" id="hb_service_section">
												<div class="service-section-header">
													<h6 class="mb-3" data-translate="hbServiceTitle">Heavy & Bulky Service Details</h6>
												</div>
												<div class="row g-3">
													<div class="col-md-6">
														<label class="form-label" data-translate="pickupFrequencyLabel">Pickup Frequency <span class="text-danger">*</span></label>
														<select class="form-select" id="hb_pickup_frequency">
															<option value="" data-translate="selectFrequency">Select frequency</option>
															<option value="once" data-translate="onceDaily">Once a Day</option>
															<option value="twice" data-translate="twiceDaily">Twice a Day</option>
														</select>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="timeSlotLabel">Time Slot(s) <span class="text-danger">*</span></label>
														<div class="row g-2" id="hb_time_slot_container">
															<!-- Dynamic time slots will be generated here -->
														</div>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="cityLabel">City <span class="text-danger">*</span></label>
														<select class="form-select" id="hb_city">
															<option value="" data-translate="selectCity">Select city</option>
															<option value="dammam" data-translate="dammamOption">Dammam</option>
															<option value="riyadh" data-translate="riyadhOption">Riyadh</option>
															<option value="jeddah" data-translate="jeddahOption">Jeddah</option>
														</select>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="districtLabel">District <span class="text-danger">*</span></label>
														<input type="text" class="form-control" id="hb_district" placeholder="Enter district" data-translate-placeholder="enterDistrict">
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="weeklyShipmentsLabel">Weekly Shipments <span class="text-danger">*</span></label>
														<input type="number" min="0" class="form-control" id="hb_weekly_shipments" placeholder="e.g. 100" data-translate-placeholder="exampleShipments">
													</div>
													<div class="col-md-3">
														<label class="form-label" data-translate="codLabel">Cash on Delivery % <span class="text-danger">*</span></label>
														<div class="input-group">
															<input type="number" min="0" max="100" class="form-control" id="hb_cod_percent">
															<span class="input-group-text">%</span>
														</div>
													</div>
													<div class="col-md-3">
														<label class="form-label" data-translate="ppdLabel">Pre Paid % <span class="text-danger">*</span></label>
														<div class="input-group">
															<input type="number" min="0" max="100" class="form-control" id="hb_ppd_percent">
															<span class="input-group-text">%</span>
														</div>
														<div class="form-text error d-none" id="err_hb_payment" data-translate="codPpdSum">
															COD + PPD must equal 100%.
														</div>
													</div>
												</div>
											</div>
										</div>
										
										<!-- International Service Option with Details -->
										<div class="service-option service-option-with-details">
											<input class="form-check-input" type="checkbox" value="international" id="service_international" name="lastmile_service_mix">
											<label class="service-option-label" for="service_international">
												<div class="service-icon">🌍</div>
												<div class="service-text" data-translate="intOption">International</div>
											</label>
											
											<!-- International Service Details Section -->
											<div class="service-details d-none" id="international_service_section">
												<div class="service-section-header">
													<h6 class="mb-3" data-translate="internationalServiceTitle">International Service Details</h6>
												</div>
												<div class="row g-3">
													<div class="col-md-6">
														<label class="form-label" data-translate="pickupFrequencyLabel">Pickup Frequency <span class="text-danger">*</span></label>
														<select class="form-select" id="international_pickup_frequency">
															<option value="" data-translate="selectFrequency">Select frequency</option>
															<option value="once" data-translate="onceDaily">Once a Day</option>
															<option value="twice" data-translate="twiceDaily">Twice a Day</option>
														</select>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="timeSlotLabel">Time Slot(s) <span class="text-danger">*</span></label>
														<div class="row g-2" id="international_time_slot_container">
															<!-- Dynamic time slots will be generated here -->
														</div>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="cityLabel">City <span class="text-danger">*</span></label>
														<select class="form-select" id="international_city">
															<option value="" data-translate="selectCity">Select city</option>
															<option value="dammam" data-translate="dammamOption">Dammam</option>
															<option value="riyadh" data-translate="riyadhOption">Riyadh</option>
															<option value="jeddah" data-translate="jeddahOption">Jeddah</option>
														</select>
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="districtLabel">District <span class="text-danger">*</span></label>
														<input type="text" class="form-control" id="international_district" placeholder="Enter district" data-translate-placeholder="enterDistrict">
													</div>
													<div class="col-md-6">
														<label class="form-label" data-translate="weeklyShipmentsLabel">Weekly Shipments <span class="text-danger">*</span></label>
														<input type="number" min="0" class="form-control" id="international_weekly_shipments" placeholder="e.g. 100" data-translate-placeholder="exampleShipments">
													</div>
													<div class="col-md-3">
														<label class="form-label" data-translate="codLabel">Cash on Delivery % <span class="text-danger">*</span></label>
														<div class="input-group">
															<input type="number" min="0" max="100" class="form-control" id="international_cod_percent">
															<span class="input-group-text">%</span>
														</div>
													</div>
													<div class="col-md-3">
														<label class="form-label" data-translate="ppdLabel">Pre Paid % <span class="text-danger">*</span></label>
														<div class="input-group">
															<input type="number" min="0" max="100" class="form-control" id="international_ppd_percent">
															<span class="input-group-text">%</span>
														</div>
														<div class="form-text error d-none" id="err_international_payment" data-translate="codPpdSum">
															COD + PPD must equal 100%.
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="form-text error d-none" id="err_lastmile_service_mix" data-translate="errLastMileServiceMix">
										Please select at least one Last Mile service.
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Company & Volumes -->
					<div class="form-section">
						<button class="btn btn-link p-0 text-decoration-none section-title collapsed" type="button"
							data-bs-toggle="collapse" data-bs-target="#secCompany" aria-expanded="false"
							data-translate="sectionCompany">Company & Volumes</button>
						<div class="collapse" id="secCompany">
							<div class="row g-3 pt-2">
								<div class="col-md-6">
									<label class="form-label" data-translate="companyLabel">Customer Company Name <span
											class="text-danger">*</span></label>
									<input type="text" class="form-control" id="company_name" required
										placeholder="Enter company name" data-translate-placeholder="enterCompanyName"
										title="Enter the official company or trade name">
									<div class="invalid-feedback" id="company-name-error"></div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="weeklyVolumeLabel">Weekly Orders <span class="text-danger">*</span></label>
									<input type="number" min="0" class="form-control" id="weekly_shipments" required
										placeholder="e.g. 5" data-translate-placeholder="exampleShipments" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="invalid-feedback" id="weekly-shipments-error"></div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="weeklyOutboundLabel">Fulfilment Outbound (Unit of Measure: Units)
									<span class="text-danger">*</span></label>
									<input type="number" min="0" class="form-control" id="weekly_units_outbound"
										required placeholder="e.g. 10" data-translate-placeholder="exampleOutbound" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="invalid-feedback" id="weekly-outbound-error"></div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="weeklyInboundLabel">Fulfilment Inbound (Unit of Measure: Units)
									<span class="text-danger">*</span></label>
									<input type="number" min="0" class="form-control" id="weekly_units_inbound" required
										placeholder="e.g. 8" data-translate-placeholder="exampleInbound" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="invalid-feedback" id="weekly-inbound-error"></div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="inbound-frequency" class="form-label" data-translate="inboundFrequencyLabel">Frequency of the Inbound</label>
									<select class="form-select" id="inbound-frequency" name="inbound-frequency" required>
										<option value="" data-translate="selectFrequency">Select frequency</option>
										<option value="daily" data-translate="dailyOption">Daily</option>
										<option value="weekly" data-translate="weeklyOption">Weekly</option>
										<option value="biweekly" data-translate="biweeklyOption">Biweekly</option>
									</select>
									<div class="invalid-feedback" id="inbound-frequency-error">
										Please select a frequency.
									</div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="avg-units" class="form-label" data-translate="avgUnitsLabel">Average Unit per Order</label>
									<input type="number" class="form-control" id="avg-units" name="avg-units" min="0" step="0.1" data-translate="avgUnits" required placeholder="e.g. 3" data-translate-placeholder="exampleAvgUnits" onkeydown="return event.keyCode !== 189 && event.keyCode !== 109">
									<div class="invalid-feedback" id="avg-units-error">
										Must be a number ≥ 0.
									</div>
								</div>
								<div class="col-md-6">
									<label class="form-label" data-translate="forecastingPeriodLabel">
										<i class="bi bi-calendar me-2"></i>
										Forecasting Period <span class="text-danger">*</span>
									</label>
									<div class="row g-2">
										<div class="col-6">
											<label class="form-label small text-muted" data-translate="startDate">Start
												Date</label>
											<input type="date" class="form-control" id="forecast_start_date" required>
										</div>
										<div class="col-6">
											<label class="form-label small text-muted" data-translate="endDate">End
												Date</label>
											<input type="date" class="form-control" id="forecast_end_date" required>
										</div>
									</div>
									<div class="form-text" data-translate="selectDateRange">Select the date range for
										your forecast</div>
									<div class="form-text error d-none" id="err_forecast_dates"></div>
								</div>
								<div class="col-md-6" id="seasonality_skus_container">
									<label class="form-label" data-translate="skusLabel">Special SKUs for Seasonality
										<small class="text-muted"><em
												data-translate="optionalNote">(optional)</em></small></label>
									<textarea class="form-control" id="seasonality_skus_notes" rows="2"
										placeholder="Optional notes about seasonal SKUs" data-translate-placeholder="optionalSeasonalNotes"></textarea>
								</div>
								<div class="col-md-6" id="special_bundles_container">
									<label class="form-label" data-translate="bundlesLabel">Special Bundles
										<small class="text-muted"><em
												data-translate="optionalNote">(optional)</em></small></label>
									<div id="bundles-container">
										<div class="bundle-item mb-2">
											<div class="row g-2">
												<div class="col-5">
													<input type="text" class="form-control bundle-name" data-translate-placeholder="bundleName" placeholder="Bundle Name">
												</div>
												<div class="col-5">
													<input type="text" class="form-control bundle-details" data-translate-placeholder="bundleDetails" placeholder="Bundle Details">
												</div>
												<div class="col-2 d-flex">
													<button type="button" class="btn btn-outline-danger btn-sm remove-bundle" onclick="removeBundle(this)" style="display: none;">
														<i class="bi bi-trash"></i>
													</button>
													<button type="button" class="btn btn-outline-success btn-sm add-bundle" onclick="addBundle()">
														<i class="bi bi-plus"></i>
													</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Submit -->
					<div class="form-section">
						<div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between">
							<div class="required-note mb-2 mb-sm-0" data-translate="requiredNote"><span
									class="text-danger">*</span> Required fields</div>
							<button type="submit" class="btn btn-primary fw-bold px-4" data-translate="submitButton">[
								Submit ]</button>
						</div>
					</div>

				</form>
			</div>
		</div>
	</main>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="assets/js/supabaseClient.js"></script>
	<script>
		async function main() {
			// Check if Supabase client is available
			if (!window.supa) {
				console.error('Supabase client not found!');
				const lang = translations[currentLanguage];
				showToast(lang.toastDatabaseError, 'error');
				return;
			}
			console.log('Supabase client found:', window.supa);
			
			// Table structure is now known - no need for checking
			console.log('Supabase client ready, table schema confirmed');
			
			// Removed auth guard - customer page is now accessible to everyone

			// Language toggle functionality
			let currentLanguage = 'en'; // Default to English
			const languageToggle = document.getElementById('languageToggle');
			const currentLangSpan = document.getElementById('currentLang');

			// Language translations
			const translations = {
				en: {
					pageTitle: 'Customer\'s forecast questionnaire',
					companyLabel: 'Customer Company Name',
					weeklyVolumeLabel: 'Weekly Orders',
					weeklyOutboundLabel: 'Fulfillment Outbound (Unit of Measure: Units)',
					weeklyInboundLabel: 'Fulfillment Inbound (Unit of Measure: Units)',
					forecastingPeriodLabel: 'Forecasting Period',
					startDate: 'Start Date',
					endDate: 'End Date',
					selectDateRange: 'Select the date range for your forecast',
					skusLabel: 'Special SKUs for Seasonality',
					codLabel: 'Cash on Delivery %',
					ppdLabel: 'Pre Paid %',
					tierSplitLabel: 'Tier Split % (Must sum to 100%)',
					serviceMixLabel: 'Service Mix',
					submitButton: '[ Submit ]',
					requiredNote: 'Required fields',
					optionalNote: '(optional)',
					sectionServiceType: 'Product Type',
					sectionCompany: 'Company & Volume',
					sectionPayments: 'Last Mile Service Structure',
					serviceTypeLabel: 'Select Product Type',
					fulfillmentOption: 'Fulfillment',
					lastMileOption: 'Last Mile',
					bundlesLabel: 'Special Bundles',
					inboundFrequencyLabel: 'Inbound Frequency',
					avgUnitsLabel: 'Average Unit per Order',
					selectFrequency: 'Select frequency',
					dailyOption: 'Daily',
					weeklyOption: 'Weekly',
					biweeklyOption: 'Bi-weekly',
					codPpdSum: 'COD and PPD percentages must sum to 100%.',
					errWeeklyShipments: 'Must be a number ≥ 0.',
					errWeeklyOutbound: 'Must be a number ≥ 0.',
					errWeeklyInbound: 'Must be a number ≥ 0.',
					errCodPercent: 'Must be between 0 and 100.',
					errPpdPercent: 'Must be between 0 and 100.',
					errInboundFrequency: 'Please select a frequency.',
					errAvgUnits: 'Must be a number ≥ 0.',
					errTierSum: 'Tier split percentages must sum to 100%.',
					errServiceMix: 'Please select at least one service mix option.',
					errDatePast: 'Start date cannot be in the past',
					errDateOrder: 'End date must be after start date',
					errDateRange: 'Forecasting period cannot exceed 2 years',
					// Toast notification messages
					toastBundleValidation: 'Please fill in both Bundle Name and Bundle Details before adding a new bundle.',
					toastServiceTypeRequired: 'Please select a product type before submitting the form.',
					toastFormValidation: 'Please fill in all required fields correctly.',
					toastFormSuccess: 'Form submitted successfully! Redirecting...',
					toastFormError: 'Error submitting form: ',
					toastDatabaseError: 'Database connection error. Please refresh the page.',
					placeholder: {
						company: 'Enter company name',
						shipments: 'e.g. 5',
						outbound: 'e.g. 10',
						inbound: 'e.g. 8',
						avgUnits: 'e.g. 3',
						forecastingPeriod: 'Select dates',
						skus: 'Optional notes about seasonal SKUs',
						bundles: 'Optional notes about special bundles',
						bundleName: 'Bundle Name',
						bundleDetails: 'Bundle Details',
						tier0: 'Tier 0 %',
						tier1: 'Tier 1 %',
						tier2: 'Tier 2 %',
						tier3: 'Tier 3 %',
						hb: 'Heavy & Bulky %',
						international: 'International %',
						parcel: 'Parcel %'
					}
				},
				ar: {
					pageTitle: 'استبيان توقعات العملاء',
					companyLabel: 'اسم شركة العميل',
					weeklyVolumeLabel: 'الطلبات الأسبوعية',
					weeklyOutboundLabel: 'الوفاء الصادر (وحدة القياس: وحدات)',
					weeklyInboundLabel: 'الوفاء الوارد (وحدة القياس: وحدات)',
					forecastingPeriodLabel: 'فترة التوقعات',
					startDate: 'تاريخ البداية',
					endDate: 'تاريخ النهاية',
					selectDateRange: 'اختر نطاق التاريخ للتوقعات',
					skusLabel: 'وحدة حفظ المخزون الخاصة للموسمية',
					codLabel: 'نسبة الدفع عند الاستلام %',
					ppdLabel: 'نسبة الدفع المسبق %',
					tierSplitLabel: 'تقسيم المستويات % (يجب أن يكون المجموع 100%)',
					serviceMixLabel: 'مزيج الخدمات',
					submitButton: '[ إرسال ]',
					requiredNote: 'الحقول المطلوبة',
					optionalNote: '(اختياري)',
					sectionServiceType: 'نوع المنتج',
					sectionCompany: 'الشركة والحجم',
					sectionPayments: 'هيكل خدمة الميل الأخير',
					serviceTypeLabel: 'اختر نوع المنتج',
					fulfillmentOption: 'تخزين',
					lastMileOption: 'الميل الأخير',
					bundlesLabel: 'الحزم الخاصة',
					inboundFrequencyLabel: 'تكرار الواردات',
					avgUnitsLabel: 'متوسط الوحدات لكل طلب',
					selectFrequency: 'اختر التكرار',
					dailyOption: 'يومي',
					weeklyOption: 'أسبوعي',
					biweeklyOption: 'كل أسبوعين',
					codPpdSum: 'يجب أن يكون مجموع نسبة الدفع عند الاستلام ونسبة الدفع المسبق 100%.',
					errWeeklyShipments: 'يجب أن يكون رقماً ≥ 0.',
					errWeeklyOutbound: 'يجب أن يكون رقماً ≥ 0.',
					errWeeklyInbound: 'يجب أن يكون رقماً ≥ 0.',
					errCodPercent: 'يجب أن يكون بين 0 و 100.',
					errPpdPercent: 'يجب أن يكون بين 0 و 100.',
					errInboundFrequency: 'يرجى اختيار التكرار.',
					errAvgUnits: 'يجب أن يكون رقماً ≥ 0.',
					errTierSum: 'يجب أن يكون مجموع تقسيم المستويات 100%.',
					errServiceMix: 'يرجى اختيار خيار واحد على الأقل من مزيج الخدمات.',
					errDatePast: 'لا يمكن أن يكون تاريخ البداية في الماضي',
					errDateOrder: 'يجب أن يكون تاريخ النهاية بعد تاريخ البداية',
					errDateRange: 'لا يمكن أن تتجاوز فترة التوقعات سنتين',
					// Toast notification messages
					toastBundleValidation: 'يرجى ملء اسم الحزمة وتفاصيل الحزمة قبل إضافة حزمة جديدة.',
					toastServiceTypeRequired: 'يرجى اختيار نوع المنتج قبل إرسال النموذج.',
					toastFormValidation: 'يرجى ملء جميع الحقول المطلوبة بشكل صحيح.',
					toastFormSuccess: 'تم إرسال النموذج بنجاح! جاري إعادة التوجيه...',
					toastFormError: 'خطأ في إرسال النموذج: ',
					toastDatabaseError: 'خطأ في الاتصال بقاعدة البيانات. يرجى تحديث الصفحة.',
					placeholder: {
						company: 'أدخل اسم الشركة',
						shipments: 'مثال: 5',
						outbound: 'مثال: 10',
						inbound: 'e.g. 8',
						avgUnits: 'e.g. 3',
						forecastingPeriod: 'اختر التواريخ',
						skus: 'ملاحظات اختيارية حول وحدة حفظ المخزون الموسمية',
						bundles: 'ملاحظات اختيارية حول الحزم الخاصة',
						bundleName: 'اسم الحزمة',
						bundleDetails: 'تفاصيل الحزمة',
						tier0: 'المستوى 0 %',
						tier1: 'المستوى 1 %',
						tier2: 'المستوى 2 %',
						tier3: 'المستوى 3 %',
						hb: 'ثقيل و متين %',
						international: 'دولي %',
						parcel: 'طرد %'
					},
					// Service options
					hbOption: 'ثقيل و متين',
					intOption: 'دولي',
					parcelOption: 'طرد',
					fulfillmentAndLastMileOption: 'تخزين والميل الأخير',
					
					// Service details
					parcelServiceTitle: 'تفاصيل خدمة الطرود',
					hbServiceTitle: 'تفاصيل خدمة الثقيل والمتين',
					internationalServiceTitle: 'تفاصيل الخدمة الدولية',
					lastMileServiceMixLabel: 'مزيج خدمات الميل الأخير',
					pickupFrequencyLabel: 'تكرار الاستلام',
					timeSlotLabel: 'أوقات الاستلام',
					cityLabel: 'المدينة',
					districtLabel: 'الحي',
					weeklyShipmentsLabel: 'الشحنات الأسبوعية',
					onceDaily: 'مرة واحدة في اليوم',
					twiceDaily: 'مرتين في اليوم',
					dammamOption: 'الدمام',
					riyadhOption: 'الرياض',
					jeddahOption: 'جدة',
					
					// Error messages
					errServiceType: 'يرجى اختيار نوع المنتج.',
					errLastMileServiceMix: 'يرجى اختيار خيار واحد على الأقل من مزيج خدمات الميل الأخير.',
					
					// Additional labels
					avgUnits: 'متوسط الوحدات لكل طلب',
					
					// Time slot labels
					firstPickup: 'الاستلام الأول',
					secondPickup: 'الاستلام الثاني',
					selectTimeSlot: 'اختر وقت الاستلام',
					selectCity: 'اختر المدينة',
					enterDistrict: 'أدخل الحي',
					selectFrequency: 'اختر التكرار',
					enterCompanyName: 'أدخل اسم الشركة',
					exampleShipments: 'مثال: 5',
					exampleOutbound: 'مثال: 10',
					exampleInbound: 'مثال: 8',
					exampleAvgUnits: 'مثال: 3',
					optionalSeasonalNotes: 'ملاحظات اختيارية حول وحدة حفظ المخزون الموسمية'
				}
			};

			// Function to update form language
			function updateFormLanguage() {
				const lang = translations[currentLanguage];

				// Set document direction for RTL support
				if (currentLanguage === 'ar') {
					document.documentElement.setAttribute('dir', 'rtl');
					document.documentElement.setAttribute('lang', 'ar');
				} else {
					document.documentElement.setAttribute('dir', 'ltr');
					document.documentElement.setAttribute('lang', 'en');
				}

				// Clear all existing translations first to prevent mixing
				document.querySelectorAll('[data-translate]').forEach(element => {
					// Reset to original English text before applying new translation
					const originalText = element.getAttribute('data-original-text') || element.textContent;
					if (!element.getAttribute('data-original-text')) {
						element.setAttribute('data-original-text', originalText);
					}
				});

				// Update all elements with data-translate attribute
				document.querySelectorAll('[data-translate]').forEach(element => {
					const key = element.getAttribute('data-translate');
					if (lang[key]) {
						if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
							// For input elements, update placeholder
							element.placeholder = lang[key];
						} else {
							// For other elements, update text content
							if (key === 'companyLabel' || key === 'weeklyVolumeLabel' || key === 'weeklyOutboundLabel' ||
								key === 'weeklyInboundLabel' || key === 'inboundFrequencyLabel' || key === 'avgUnitsLabel' || key === 'forecastingPeriodLabel' || key === 'codLabel' ||
								key === 'ppdLabel' ||
								key === 'serviceMixLabel') {
								element.innerHTML = lang[key] + ' <span class="text-danger">*</span>';
							} else if (key === 'skusLabel' || key === 'bundlesLabel') {
								element.innerHTML = lang[key] + ' <small class="text-muted"><em>' + lang.optionalNote + '</em></small>';
							} else if (key === 'requiredNote') {
								element.innerHTML = '<span class="text-danger">*</span> ' + lang[key];
							} else {
								element.textContent = lang[key];
							}
						}
					}
				});

				// Update placeholders using data-translate-placeholder attribute
				document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
					const key = element.getAttribute('data-translate-placeholder');
					// Store original placeholder if not already stored
					if (!element.getAttribute('data-original-placeholder')) {
						element.setAttribute('data-original-placeholder', element.placeholder);
					}
					
					if (lang.placeholder && lang.placeholder[key]) {
						element.placeholder = lang.placeholder[key];
					} else if (lang[key]) {
						// Check main translations object for placeholder translations
						element.placeholder = lang[key];
					}
					// Debug logging
					console.log(`Updating placeholder for ${element.id}: ${key} -> ${element.placeholder}`);
				});

				// Regenerate time slot dropdowns with new language
				const timeSlotContainers = document.querySelectorAll('[id$="_time_slot_container"]');
				timeSlotContainers.forEach(container => {
					const serviceType = container.id.replace('_time_slot_container', '');
					const frequencySelect = document.getElementById(`${serviceType}_pickup_frequency`);
					if (frequencySelect && frequencySelect.value) {
						// Trigger the change event to regenerate with new language
						frequencySelect.dispatchEvent(new Event('change'));
					}
				});
			}

			// Load saved language preference
			const savedLanguage = localStorage.getItem('customerFormLanguage');
			if (savedLanguage && (savedLanguage === 'en' || savedLanguage === 'ar')) {
				currentLanguage = savedLanguage;
				updateFormLanguage();
			} else {
				// If no saved language, update with default (English)
				updateFormLanguage();
			}

			// Add event listener for language toggle button
			languageToggle.addEventListener('click', function() {
				// Toggle between English and Arabic
				currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
				
				// Save language preference
				localStorage.setItem('customerFormLanguage', currentLanguage);
				
				// Clear any existing translations first
				document.querySelectorAll('[data-translate]').forEach(element => {
					const originalText = element.getAttribute('data-original-text');
					if (originalText) {
						element.textContent = originalText;
					}
				});
				
				// Reset placeholders to original
				document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
					const originalPlaceholder = element.getAttribute('data-original-placeholder');
					if (originalPlaceholder) {
						element.placeholder = originalPlaceholder;
					}
				});
				
				// Update form language
				updateFormLanguage();
				
				// Update button text
				currentLangSpan.textContent = currentLanguage === 'en' ? 'English' : 'العربية';
			});

			// Function to handle service type changes
			function handleServiceTypeChange() {
				console.log('🔧 handleServiceTypeChange: Initializing...');
				
				// Get all service type radio buttons
				const serviceTypeRadios = document.querySelectorAll('input[name="service-type"]');
				const seasonalityContainer = document.getElementById('seasonality_skus_container');
				const bundlesContainer = document.getElementById('special_bundles_container');
				const lastMileSection = document.querySelector('[data-bs-target="#secPayments"]')?.closest('.form-section');
				const lastMileCollapse = document.getElementById('secPayments');

				// Log initial state
				console.log('🔧 DOM Elements found:', {
					serviceTypeRadios: serviceTypeRadios.length,
					seasonalityContainer: !!seasonalityContainer,
					bundlesContainer: !!bundlesContainer,
					lastMileSection: !!lastMileSection,
					lastMileCollapse: !!lastMileCollapse,
					bootstrap: typeof bootstrap !== 'undefined' ? 'available' : 'not available'
				});

				// Function to handle section visibility
				const updateSections = (type) => {
					console.log('🔧 Updating sections for type:', type);
					
					const isFulfillment = type.includes('fulfillment');
					const isLastMile = type.includes('last-mile');
					
					// Handle 'none' case - hide all sections
					if (type === 'none') {
						if (seasonalityContainer) seasonalityContainer.style.display = 'none';
						if (bundlesContainer) bundlesContainer.style.display = 'none';
						if (lastMileSection) lastMileSection.style.display = 'none';
						// Clear any service mix errors
						const errorElement = document.getElementById('err_lastmile_service_mix');
						if (errorElement) errorElement.classList.add('d-none');
						document.querySelectorAll('.service-option').forEach(option => option.classList.remove('border-danger'));
						return;
					}

					console.log('🔧 Section visibility:', { isFulfillment, isLastMile });

					// Update visibility
					if (seasonalityContainer) {
						seasonalityContainer.style.display = isFulfillment ? 'block' : 'none';
						console.log('🔧 Seasonality container display:', seasonalityContainer.style.display);
					}
					if (bundlesContainer) {
						bundlesContainer.style.display = isFulfillment ? 'block' : 'none';
						console.log('🔧 Bundles container display:', bundlesContainer.style.display);
					}
					if (lastMileSection) {
						lastMileSection.style.display = isLastMile ? 'block' : 'none';
						console.log('🔧 Last Mile section display:', lastMileSection.style.display);
						
						// Clear service mix errors when hiding the section
						if (!isLastMile) {
							const errorElement = document.getElementById('err_lastmile_service_mix');
							if (errorElement) errorElement.classList.add('d-none');
							document.querySelectorAll('.service-option').forEach(option => option.classList.remove('border-danger'));
						}
					}

					// Handle Bootstrap collapse for Last Mile section
					if (lastMileCollapse && typeof bootstrap !== 'undefined') {
						try {
							const bsCollapse = bootstrap.Collapse.getInstance(lastMileCollapse) || 
								new bootstrap.Collapse(lastMileCollapse, { toggle: false });
							
							if (isLastMile) {
								bsCollapse.show();
								console.log('🔧 Last Mile section expanded');
							} else {
								bsCollapse.hide();
							}
						} catch (error) {
							console.error('🔧 Error managing Bootstrap collapse:', error);
						}
					}
				};

				// Add event listeners if radios exist
				console.log('Debug - Before adding event listeners');
				console.log('serviceTypeRadios:', serviceTypeRadios);
				console.log('serviceTypeRadios length:', serviceTypeRadios ? serviceTypeRadios.length : 0);

				if (serviceTypeRadios && serviceTypeRadios.length > 0) {
					serviceTypeRadios.forEach((radio, index) => {
						console.log(`Radio ${index}:`, radio);
						if (radio) {  // Additional null check just in case
							radio.addEventListener('change', function() {
								console.log('Radio changed:', this.value);
								updateSections(this.value);
							});
						} else {
							console.warn(`Radio at index ${index} is null or undefined`);
						}
					});

					// Set initial state
					const checkedRadio = document.querySelector('input[name="service-type"]:checked');
					console.log('Checked radio:', checkedRadio);
					if (checkedRadio) {
						console.log('🔧 Setting initial state for:', checkedRadio.value);
						updateSections(checkedRadio.value);
					} else {
						console.log('🔧 No radio checked initially, hiding all sections');
						updateSections('none');
					}
					
					// Also hide any service mix errors initially
					const errorElement = document.getElementById('err_lastmile_service_mix');
					if (errorElement) {
						errorElement.classList.add('d-none');
					}
				} else {
					console.warn('🔧 No service type radio buttons found or serviceTypeRadios is null');
				}

				console.log('🔧 handleServiceTypeChange: Initialization complete');
			}

			// Format dates for input fields (YYYY-MM-DD)
			const formatDate = (date) => {
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				return `${year}-${month}-${day}`;
			};

			// Set default dates for forecasting period
			const today = new Date();
			const tomorrow = new Date();
			const threeMonthsLater = new Date();
			tomorrow.setDate(today.getDate() + 1); // Start from tomorrow
			threeMonthsLater.setMonth(tomorrow.getMonth() + 3);

			// Set initial dates and constraints
			const forecastStartDate = document.getElementById('forecast_start_date');
			const forecastEndDate = document.getElementById('forecast_end_date');

			// Set minimum date to today for start date
			forecastStartDate.min = formatDate(today);
			forecastStartDate.value = formatDate(tomorrow);
			forecastEndDate.value = formatDate(threeMonthsLater);

			const form = document.getElementById('customerForm');
			const company = document.getElementById('company_name');
			const weeklyShip = document.getElementById('weekly_shipments');
			const weeklyOut = document.getElementById('weekly_units_outbound');
			const weeklyIn = document.getElementById('weekly_units_inbound');
			const inboundFreq = document.getElementById('inbound-frequency');
			const avgUnits = document.getElementById('avg-units');
			const notes = document.getElementById('seasonality_skus_notes');
			const bundlesNotes = document.getElementById('special_bundles_notes');
			const serviceType = document.querySelector('input[name="service-type"]:checked');
			const cod = document.getElementById('cod_percent');
			const ppd = document.getElementById('ppd_percent');

			function show(el, flag) { if (!el) return; el.classList[flag ? 'remove' : 'add']('d-none'); }

			function showError(messageKey) {
				const errorElement = document.getElementById('err_forecast_dates');
				if (errorElement) {
					const lang = translations[currentLanguage];
					errorElement.textContent = lang[messageKey] || messageKey;
					errorElement.classList.remove('d-none');
				}
			}
			function validateNumericInput(input, errorElement, min = 0, max = null) {
				if (!input || !errorElement) {
					console.warn('validateNumericInput: missing input or errorElement');
					return false;
				}
				const value = parseFloat(input.value);
				if (isNaN(value) || value < min || (max !== null && value > max)) {
					input.classList.add('is-invalid');
					errorElement.classList.remove('d-none');
					return false;
				}
				input.classList.remove('is-invalid');
				errorElement.classList.add('d-none');
				return true;
			}

			function validateInboundFrequency() {
				const select = document.getElementById('inbound-frequency');
				const errorElement = document.getElementById('inbound-frequency-error');
				
				if (!select.value) {
					select.classList.add('is-invalid');
					errorElement.textContent = translations[currentLanguage].errInboundFrequency;
					return false;
				}
				
				select.classList.remove('is-invalid');
				return true;
			}

			function validateAvgUnits() {
				const input = document.getElementById('avg-units');
				const errorElement = document.getElementById('avg-units-error');
				
				console.log('🔧 validateAvgUnits - Input value:', input.value, 'Type:', typeof input.value);
				
				const value = parseFloat(input.value);
				if (isNaN(value) || value < 0) {
					console.log('🔧 validateAvgUnits - Validation failed:', { value, isNaN: isNaN(value), lessThanZero: value < 0 });
					input.classList.add('is-invalid');
					errorElement.textContent = translations[currentLanguage].errAvgUnits;
					return false;
				}
				
				console.log('🔧 validateAvgUnits - Validation passed:', value);
				input.classList.remove('is-invalid');
				return true;
			}

			// Add missing validateSum100 function
			function validateSum100(inputs, errorElement) {
				const sum = inputs.reduce((total, input) => {
					const value = parseFloat(input.value) || 0;
					return total + value;
				}, 0);
				
				if (Math.abs(sum - 100) > 0.01) { // Allow small floating point differences
					inputs.forEach(input => input.classList.add('is-invalid'));
					errorElement.classList.remove('d-none');
					return false;
				}
				
				inputs.forEach(input => input.classList.remove('is-invalid'));
				errorElement.classList.add('d-none');
				return true;
			}

			// Date validation function for form submission
			function validateDateRange() {
				if (forecastStartDate.value && forecastEndDate.value) {
					const startDate = new Date(forecastStartDate.value);
					const endDate = new Date(forecastEndDate.value);
					return endDate > startDate;
				}
				return false;
			}
			// Add null checks before adding event listeners
if (cod && ppd) {
				['input', 'change'].forEach(evt => { cod.addEventListener(evt, validateCodPpd); ppd.addEventListener(evt, validateCodPpd); });
			}
			function validateCodPpd() { 
				// Add null checks for cod and ppd elements
				if (!cod || !ppd) return true;
				
				const codValid = validateNumericInput(cod, document.getElementById('err_cod_percent'), 0, 100); 
				const ppdValid = validateNumericInput(ppd, document.getElementById('err_ppd_percent'), 0, 100); 
				
				// Check if both values are present and valid numbers
				const codValue = parseFloat(cod.value) || 0;
				const ppdValue = parseFloat(ppd.value) || 0;
				const sum = codValue + ppdValue;
				
				// Show/hide sum error message
				const sumErrorElement = document.getElementById('err_cod_ppd_sum');
				if (sumErrorElement) {
					if (cod.value && ppd.value && sum !== 100) {
						sumErrorElement.classList.remove('d-none');
						sumErrorElement.classList.add('d-block');
					} else {
						sumErrorElement.classList.add('d-none');
						sumErrorElement.classList.remove('d-block');
					}
				}
				
				const sumOk = sum === 100;
				return codValid && ppdValid && sumOk; 
			}
			function validateForecastDates() {
				const startDate = new Date(forecastStartDate.value);
				const endDate = new Date(forecastEndDate.value);
				const today = new Date();
				today.setHours(0, 0, 0, 0); // Reset time for accurate comparison

				// Reset any existing error and styling
				const errorElement = document.getElementById('err_forecast_dates');
				if (errorElement) errorElement.classList.add('d-none');
				forecastStartDate.classList.remove('is-invalid');
				forecastEndDate.classList.remove('is-invalid');

				// Check if dates are selected
				if (!forecastStartDate.value || !forecastEndDate.value) {
					if (!forecastStartDate.value) forecastStartDate.classList.add('is-invalid');
					if (!forecastEndDate.value) forecastEndDate.classList.add('is-invalid');
					return false;
				}

				// Check if start date is not in the past
				startDate.setHours(0, 0, 0, 0);
				if (startDate < today) {
					showError('errDatePast');
					forecastStartDate.classList.add('is-invalid');
					return false;
				}

				// Check if end date is after start date (not same day or before)
				endDate.setHours(0, 0, 0, 0);
				if (endDate <= startDate) {
					showError('errDateOrder');
					forecastEndDate.classList.add('is-invalid');
					forecastStartDate.classList.add('is-invalid');
					return false;
				}

				// Check if period is not too long (max 2 years)
				const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
				if (daysDiff > 730) {
					showError('errDateRange');
					forecastEndDate.classList.add('is-invalid');
					return false;
				}

				return true;
			}

			// Date validation function for form submission
			function validateDateRange() {
				if (forecastStartDate.value && forecastEndDate.value) {
					const startDate = new Date(forecastStartDate.value);
					const endDate = new Date(forecastEndDate.value);
					return endDate > startDate;
				}
				return false;
			}
			// Add null checks before adding event listeners
			if (cod && ppd) {
				['input', 'change'].forEach(evt => { cod.addEventListener(evt, validateCodPpd); ppd.addEventListener(evt, validateCodPpd); });
				validateCodPpd();
				// Add event listeners for percentage inputs to prevent negative values and values over 100
				[cod, ppd].forEach(input => {
					input.addEventListener('input', function() {
					// Prevent negative values
					if (this.value < 0) this.value = 0;
					// Prevent values over 100 for percentage fields
					if (this.value > 100) this.value = 100;
				});
				});
			}
			const weeklyShipmentsInput = document.getElementById('weekly_shipments');
			const weeklyOutboundInput = document.getElementById('weekly_units_outbound');
			const weeklyInboundInput = document.getElementById('weekly_units_inbound');
			const inboundFrequencySelect = document.getElementById('inbound-frequency');
			const avgUnitsInput = document.getElementById('avg-units');

			// Add debugging for avg units field
			avgUnitsInput.addEventListener('input', (e) => {
				console.log('🔧 avgUnits input event - Value:', e.target.value, 'Type:', typeof e.target.value);
			});
			
			avgUnitsInput.addEventListener('change', (e) => {
				console.log('🔧 avgUnits change event - Value:', e.target.value, 'Type:', typeof e.target.value);
			});

			weeklyShipmentsInput.addEventListener('input', () => {
				// Prevent negative values
				if (weeklyShipmentsInput.value < 0) weeklyShipmentsInput.value = 0;
				validateNumericInput(weeklyShipmentsInput, document.getElementById('weekly-shipments-error'));
			});
			weeklyOutboundInput.addEventListener('input', () => {
				// Prevent negative values
				if (weeklyOutboundInput.value < 0) weeklyOutboundInput.value = 0;
				validateNumericInput(weeklyOutboundInput, document.getElementById('weekly-outbound-error'));
			});
			weeklyInboundInput.addEventListener('input', () => {
				// Prevent negative values
				if (weeklyInboundInput.value < 0) weeklyInboundInput.value = 0;
				validateNumericInput(weeklyInboundInput, document.getElementById('weekly-inbound-error'));
			});

			inboundFrequencySelect.addEventListener('change', validateInboundFrequency);
			avgUnitsInput.addEventListener('input', () => {
				// Prevent negative values
				if (avgUnitsInput.value < 0) avgUnitsInput.value = 0;
				validateAvgUnits();
			});

			function validateServiceType() {
				const selectedServiceType = document.querySelector('input[name="service-type"]:checked');
				if (!selectedServiceType) {
					// Add visual feedback for missing service type selection
					const serviceTypeContainer = document.querySelector('.d-flex.gap-3');
					if (serviceTypeContainer) {
						serviceTypeContainer.classList.add('border', 'border-danger', 'rounded', 'p-2');
					}
					return false;
				} else {
					// Remove error styling if service type is selected
					const serviceTypeContainer = document.querySelector('.d-flex.gap-3');
					if (serviceTypeContainer) {
						serviceTypeContainer.classList.remove('border', 'border-danger', 'rounded', 'p-2');
					}
					return true;
				}
			}

			// Add event listeners for service type radio buttons
			document.querySelectorAll('input[name="service-type"]').forEach(radio => {
				radio.addEventListener('change', validateServiceType);
			});

			// Enhanced input sanitization for company name
			const companyNameInput = document.getElementById('company_name');
			companyNameInput.addEventListener('input', function() {
				// Remove leading/trailing spaces and limit length
				this.value = this.value.trim().substring(0, 100);
			});

			// Enhanced date validation with event listeners
			function updateDateConstraints() {
    if (forecastStartDate.value) {
        // Set end date min to start date + 1 day
        const startDate = new Date(forecastStartDate.value);
        startDate.setDate(startDate.getDate() + 1);
        forecastEndDate.min = formatDate(startDate);

					// If end date is now invalid, suggest a new date
					if (forecastEndDate.value && forecastEndDate.value <= forecastStartDate.value) {
						// Auto-suggest end date 3 months after start date
						const suggestedEndDate = new Date(forecastStartDate.value);
						suggestedEndDate.setMonth(suggestedEndDate.getMonth() + 3);
						forecastEndDate.value = formatDate(suggestedEndDate);
					}
				}
			}

			forecastStartDate.addEventListener('change', () => {
				updateDateConstraints();
				validateForecastDates();
			});

			forecastStartDate.addEventListener('input', () => {
				updateDateConstraints();
				validateForecastDates();
			});

			forecastEndDate.addEventListener('change', () => {
				validateForecastDates();
			});

			forecastEndDate.addEventListener('input', () => {
				validateForecastDates();
			});

			// Real-time validation on blur for better UX
			forecastStartDate.addEventListener('blur', () => {
				validateForecastDates();
			});

			forecastEndDate.addEventListener('blur', () => {
				validateForecastDates();
			});

			// Initialize date constraints on page load
			updateDateConstraints();

			// Add visual validation indicators
			forecastStartDate.classList.add('date-input');
			forecastEndDate.classList.add('date-input');

			// Last Mile Service Mix validation and helper functions
			function validateLastMileServiceMix() {
				// First check if the product type includes last-mile services
				const selectedServiceType = document.querySelector('input[name="service-type"]:checked');
				if (!selectedServiceType || !selectedServiceType.value.includes('last-mile')) {
					// If not last-mile, hide any existing errors and return true
					const errorElement = document.getElementById('err_lastmile_service_mix');
					if (errorElement) errorElement.classList.add('d-none');
					document.querySelectorAll('.service-option').forEach(option => option.classList.remove('border-danger'));
					return true;
				}
				
				const serviceMixCheckboxes = document.querySelectorAll('input[name="lastmile_service_mix"]:checked');
				const errorElement = document.getElementById('err_lastmile_service_mix');
				
				if (serviceMixCheckboxes.length === 0) {
					// Show error if no service mix is selected
					if (errorElement) errorElement.classList.remove('d-none');
					document.querySelectorAll('.service-option').forEach(option => option.classList.add('border-danger'));
					showToast('Please select at least one service mix option', 'warning');
					return false;
				} else {
					// Hide error if at least one service mix is selected
					if (errorElement) errorElement.classList.add('d-none');
					document.querySelectorAll('.service-option').forEach(option => option.classList.remove('border-danger'));
					
					// Now validate that at least one service section is completely filled out
					return validateLastMileServiceSections();
				}
			}

			function getSelectedLastMileServiceMix() {
				const serviceMixCheckboxes = document.querySelectorAll('input[name="lastmile_service_mix"]:checked');
				// Return empty string if no checkboxes are selected to avoid null reference error
				return serviceMixCheckboxes.length > 0 ? Array.from(serviceMixCheckboxes).map(cb => cb.value).join(',') : '';
			}
			
			// Validate that at least one Last Mile service section is completely filled out
			function validateLastMileServiceSections() {
				const serviceType = document.querySelector('input[name="service-type"]:checked')?.value;
				
				// Only validate service sections if Last Mile is selected
				if (!serviceType || !serviceType.includes('last-mile')) {
					return true;
				}
				
				// Get selected service mix options
				const parcelSelected = document.getElementById('service_parcel')?.checked;
				const hbSelected = document.getElementById('service_hb')?.checked;
				const internationalSelected = document.getElementById('service_international')?.checked;
				
				// Check if at least one service has all required fields filled
				let atLeastOneServiceComplete = false;
				
				// Validate Parcel section if selected
				if (parcelSelected) {
					atLeastOneServiceComplete = validateServiceSection('parcel_service_section') || atLeastOneServiceComplete;
				}
				
				// Validate Heavy & Bulky section if selected
				if (hbSelected) {
					atLeastOneServiceComplete = validateServiceSection('hb_service_section') || atLeastOneServiceComplete;
				}
				
				// Validate International section if selected
				if (internationalSelected) {
					atLeastOneServiceComplete = validateServiceSection('international_service_section') || atLeastOneServiceComplete;
				}
				
				if (!atLeastOneServiceComplete) {
					showToast('Please complete all fields for at least one service type', 'warning');
					return false;
				}
				
				return true;
			}
			
			// Helper function to validate a single service section
			function validateServiceSection(sectionId) {
				const section = document.getElementById(sectionId);
				if (!section) return false;
				
				// Check pickup frequency
				const pickupFreq = section.querySelector('.pickup-frequency');
				
				// Check time slots based on pickup frequency
				let timeSlotsFilled = false;
				if (pickupFreq && pickupFreq.value === 'Once a Day') {
					const timeSlot = section.querySelector('.time-slot');
					timeSlotsFilled = timeSlot && timeSlot.value;
				} else if (pickupFreq && pickupFreq.value === 'Twice a Day') {
					const morningSlot = section.querySelector('.morning-slot');
					const afternoonSlot = section.querySelector('.afternoon-slot');
					timeSlotsFilled = morningSlot && afternoonSlot && 
						morningSlot.value && afternoonSlot.value && 
						morningSlot.value !== afternoonSlot.value;
				}
				
				// Check location fields
				const city = section.querySelector('.city');
				const district = section.querySelector('.district');
				const locationValid = city && city.value && district && district.value;
				
				// Check weekly shipments
				const weeklyShipments = section.querySelector('.weekly-shipments');
				const shipmentsValid = weeklyShipments && weeklyShipments.value && !isNaN(weeklyShipments.value);
				
				// Check payment percentages
				const cod = section.querySelector('.cod-percent');
				const ppd = section.querySelector('.ppd-percent');
				const paymentValid = cod && ppd && 
					!isNaN(cod.value) && !isNaN(ppd.value) && 
					Number(cod.value) >= 0 && Number(ppd.value) >= 0 && 
					Number(cod.value) + Number(ppd.value) === 100;
				
				// Check if all required fields are filled
				return pickupFreq && pickupFreq.value && timeSlotsFilled && 
					locationValid && shipmentsValid && paymentValid;
			}

			// Handle Last Mile service mix selection
			function handleLastMileServiceMixChange() {
				const parcelCheckbox = document.getElementById('service_parcel');
				const hbCheckbox = document.getElementById('service_hb');
				const internationalCheckbox = document.getElementById('service_international');

				const parcelSection = document.getElementById('parcel_service_section');
				const hbSection = document.getElementById('hb_service_section');
				const internationalSection = document.getElementById('international_service_section');

				// Show/hide sections based on checkbox selection
				if (parcelCheckbox) {
					parcelCheckbox.addEventListener('change', function() {
						if (this.checked) {
							parcelSection.classList.remove('d-none');
							// Make sure the parent service-option-with-details is visible
							const parentOption = this.closest('.service-option-with-details');
							if (parentOption) {
								parentOption.classList.add('active');
							}
						} else {
							parcelSection.classList.add('d-none');
							// Clear inputs when unchecked
							clearServiceSectionInputs(parcelSection);
							// Remove active class from parent if needed
							const parentOption = this.closest('.service-option-with-details');
							if (parentOption) {
								parentOption.classList.remove('active');
							}
						}
					});
				}

				if (hbCheckbox) {
					hbCheckbox.addEventListener('change', function() {
						if (this.checked) {
							hbSection.classList.remove('d-none');
							// Make sure the parent service-option-with-details is visible
							const parentOption = this.closest('.service-option-with-details');
							if (parentOption) {
								parentOption.classList.add('active');
							}
						} else {
							hbSection.classList.add('d-none');
							// Clear inputs when unchecked
							clearServiceSectionInputs(hbSection);
							// Remove active class from parent if needed
							const parentOption = this.closest('.service-option-with-details');
							if (parentOption) {
								parentOption.classList.remove('active');
							}
						}
					});
				}

				if (internationalCheckbox) {
					internationalCheckbox.addEventListener('change', function() {
						if (this.checked) {
							internationalSection.classList.remove('d-none');
							// Make sure the parent service-option-with-details is visible
							const parentOption = this.closest('.service-option-with-details');
							if (parentOption) {
								parentOption.classList.add('active');
							}
						} else {
							internationalSection.classList.add('d-none');
							// Clear inputs when unchecked
							clearServiceSectionInputs(internationalSection);
							// Remove active class from parent if needed
							const parentOption = this.closest('.service-option-with-details');
							if (parentOption) {
								parentOption.classList.remove('active');
							}
						}
					});
				}

				// Initialize sections based on current checkbox state
				if (parcelCheckbox && parcelCheckbox.checked) {
					parcelSection.classList.remove('d-none');
					const parentOption = parcelCheckbox.closest('.service-option-with-details');
					if (parentOption) {
						parentOption.classList.add('active');
					}
				}

				if (hbCheckbox && hbCheckbox.checked) {
					hbSection.classList.remove('d-none');
					const parentOption = hbCheckbox.closest('.service-option-with-details');
					if (parentOption) {
						parentOption.classList.add('active');
					}
				}

				if (internationalCheckbox && internationalCheckbox.checked) {
					internationalSection.classList.remove('d-none');
					const parentOption = internationalCheckbox.closest('.service-option-with-details');
					if (parentOption) {
						parentOption.classList.add('active');
					}
				}
			}

			// Helper function to clear inputs in a service section
			function clearServiceSectionInputs(section) {
				if (!section) return;
				
				// Clear text inputs and numbers
				section.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
					input.value = '';
				});
				
				// Reset selects
				section.querySelectorAll('select').forEach(select => {
					select.selectedIndex = 0;
				});
				
				// Hide time slot containers
				const timeSlotContainer = section.querySelector('[id$="_time_slot_container"]');
				if (timeSlotContainer) {
					timeSlotContainer.innerHTML = '';
				}
			}
			
			// Setup pickup frequency handlers for all service types
			function setupPickupFrequencyHandlers() {
				// Define time slots (these would come from Ops in a real scenario)
				const timeSlots = [
					{ value: 'morning', label: '7:00 AM - 9:00 AM' },
					{ value: 'noon', label: '11:00 PM - 1:00 PM' },
					{ value: 'afternoon', label: '1:00 PM - 2:00 PM' },
					{ value: 'evening', label: '2:00 PM - 4:00 PM' }
				];
				
				// Setup handlers for each service type
				setupPickupFrequencyHandler('parcel', timeSlots);
				setupPickupFrequencyHandler('hb', timeSlots);
				setupPickupFrequencyHandler('international', timeSlots);
			}
			
			// Setup pickup frequency handler for a specific service type
			function setupPickupFrequencyHandler(serviceType, timeSlots) {
				const frequencySelect = document.getElementById(`${serviceType}_pickup_frequency`);
				const timeSlotContainer = document.getElementById(`${serviceType}_time_slot_container`);
				
				if (!frequencySelect || !timeSlotContainer) return;
				
				frequencySelect.addEventListener('change', function() {
					// Clear existing time slots
					timeSlotContainer.innerHTML = '';
					
					if (this.value === 'once') {
						// Once a day - single time slot selection
						const col = document.createElement('div');
						col.className = 'col-12';
						
						const select = document.createElement('select');
						select.className = 'form-select';
						select.id = `${serviceType}_time_slot`;
						select.name = `${serviceType}_time_slot`;
						
						// Add default option
						const defaultOption = document.createElement('option');
						defaultOption.value = '';
						defaultOption.textContent = translations[currentLanguage].selectTimeSlot;
						select.appendChild(defaultOption);
						
						// Add time slot options
						timeSlots.forEach(slot => {
							const option = document.createElement('option');
							option.value = slot.value;
							option.textContent = slot.label;
							select.appendChild(option);
						});
						
						col.appendChild(select);
						timeSlotContainer.appendChild(col);
					} else if (this.value === 'twice') {
						// Twice a day - two time slot selections
						const morningCol = document.createElement('div');
						morningCol.className = 'col-md-6';
						
						const morningLabel = document.createElement('label');
						morningLabel.className = 'form-label small';
						morningLabel.textContent = translations[currentLanguage].firstPickup;
						morningCol.appendChild(morningLabel);
						
						const morningSelect = document.createElement('select');
						morningSelect.className = 'form-select';
						morningSelect.id = `${serviceType}_time_slot_1`;
						morningSelect.name = `${serviceType}_time_slot_1`;
						
						// Add default option
						const morningDefaultOption = document.createElement('option');
						morningDefaultOption.value = '';
						morningDefaultOption.textContent = translations[currentLanguage].selectTimeSlot;
						morningSelect.appendChild(morningDefaultOption);
						
						// Add time slot options
						timeSlots.forEach(slot => {
							const option = document.createElement('option');
							option.value = slot.value;
							option.textContent = slot.label;
							morningSelect.appendChild(option);
						});
						
						morningCol.appendChild(morningSelect);
						timeSlotContainer.appendChild(morningCol);
						
						const afternoonCol = document.createElement('div');
						afternoonCol.className = 'col-md-6';
						
						const afternoonLabel = document.createElement('label');
						afternoonLabel.className = 'form-label small';
						afternoonLabel.textContent = translations[currentLanguage].secondPickup;
						afternoonCol.appendChild(afternoonLabel);
						
						const afternoonSelect = document.createElement('select');
						afternoonSelect.className = 'form-select';
						afternoonSelect.id = `${serviceType}_time_slot_2`;
						afternoonSelect.name = `${serviceType}_time_slot_2`;
						
						// Add default option
						const afternoonDefaultOption = document.createElement('option');
						afternoonDefaultOption.value = '';
						afternoonDefaultOption.textContent = translations[currentLanguage].selectTimeSlot;
						afternoonSelect.appendChild(afternoonDefaultOption);
						
						// Add time slot options
						timeSlots.forEach(slot => {
							const option = document.createElement('option');
							option.value = slot.value;
							option.textContent = slot.label;
							afternoonSelect.appendChild(option);
						});
						
						afternoonCol.appendChild(afternoonSelect);
						timeSlotContainer.appendChild(afternoonCol);
						
						// Add validation to ensure different time slots are selected
						morningSelect.addEventListener('change', function() {
							validateTimeSlots(morningSelect, afternoonSelect);
						});
						
						afternoonSelect.addEventListener('change', function() {
							validateTimeSlots(morningSelect, afternoonSelect);
						});
					}
				});
			}
			
			// Validate that two different time slots are selected
			function validateTimeSlots(slot1, slot2) {
				if (slot1.value && slot2.value && slot1.value === slot2.value) {
					// If both slots are the same, show warning
					slot2.classList.add('is-invalid');
					showToast('Please select two different time slots', 'warning');
				} else {
					// Clear warning
					slot2.classList.remove('is-invalid');
				}
			}

			// Bundle management functions (global scope)
			function addBundle() {
				// Check if the last bundle has both fields filled
				const bundleItems = document.querySelectorAll('.bundle-item');
				if (bundleItems.length > 0) {
					const lastBundle = bundleItems[bundleItems.length - 1];
					const lastBundleName = lastBundle.querySelector('.bundle-name').value.trim();
					const lastBundleDetails = lastBundle.querySelector('.bundle-details').value.trim();
					
					if (lastBundleName === '' || lastBundleDetails === '') {
						const lang = translations[currentLanguage];
						showToast(lang.toastBundleValidation, 'warning');
						return;
					}
				}
				
				const container = document.getElementById('bundles-container');
				const bundleItem = document.createElement('div');
				bundleItem.className = 'bundle-item mb-2';
				bundleItem.innerHTML = `
					<div class="row g-2">
						<div class="col-5">
							<input type="text" class="form-control bundle-name" data-translate-placeholder="bundleName" placeholder="${translations[currentLanguage].placeholder.bundleName}">
						</div>
						<div class="col-5">
							<input type="text" class="form-control bundle-details" data-translate-placeholder="bundleDetails" placeholder="${translations[currentLanguage].placeholder.bundleDetails}">
						</div>
						<div class="col-2 d-flex">
							<button type="button" class="btn btn-outline-danger btn-sm remove-bundle" onclick="removeBundle(this)">
								<i class="bi bi-trash"></i>
							</button>
							<button type="button" class="btn btn-outline-success btn-sm add-bundle" onclick="addBundle()">
								<i class="bi bi-plus"></i>
							</button>
						</div>
					</div>
				`;
				container.appendChild(bundleItem);
				updateBundleButtons();
			}
			
			function removeBundle(button) {
				const bundleItem = button.closest('.bundle-item');
				bundleItem.remove();
				updateBundleButtons();
			}
			
			function updateBundleButtons() {
				const bundleItems = document.querySelectorAll('.bundle-item');
				const addButtons = document.querySelectorAll('.add-bundle');
				const removeButtons = document.querySelectorAll('.remove-bundle');
				
				// Hide all add buttons except the last one
				addButtons.forEach((btn, index) => {
					btn.style.display = index === bundleItems.length - 1 ? 'block' : 'none';
				});
				
				// Show remove buttons only if there's more than one bundle
				removeButtons.forEach(btn => {
					btn.style.display = bundleItems.length > 1 ? 'block' : 'none';
				});
			}
			
			// Toast notification function
			function showToast(message, type = 'info') {
				// Remove existing toast if any
				const existingToast = document.querySelector('.custom-toast');
				if (existingToast) {
					existingToast.remove();
				}
				
				// Create toast element
				const toast = document.createElement('div');
				toast.className = `custom-toast toast-${type}`;
				
				// Set icon based on type
				let icon = '';
				switch(type) {
					case 'success': icon = '<i class="bi bi-check-circle-fill"></i>'; break;
					case 'warning': icon = '<i class="bi bi-exclamation-triangle-fill"></i>'; break;
					case 'error': icon = '<i class="bi bi-x-circle-fill"></i>'; break;
					default: icon = '<i class="bi bi-info-circle-fill"></i>'; break;
				}
				
				toast.innerHTML = `
					<div class="toast-content">
						<div class="toast-icon">${icon}</div>
						<div class="toast-message">${message}</div>
						<button class="toast-close" onclick="this.parentElement.parentElement.remove()">
							<i class="bi bi-x"></i>
						</button>
					</div>
				`;
				
				// Add to page
				document.body.appendChild(toast);
				
				// Show with animation
				setTimeout(() => toast.classList.add('show'), 100);
				
				// Auto remove after 5 seconds
				setTimeout(() => {
					if (toast.parentElement) {
						toast.classList.remove('show');
						setTimeout(() => toast.remove(), 300);
					}
				}, 5000);
			}
			
			// Make functions global
			window.addBundle = addBundle;
			window.removeBundle = removeBundle;
			window.showToast = showToast;
			
			// Initialize bundle buttons
			updateBundleButtons();
			
			// Initialize service type change handling
			handleServiceTypeChange();
			
			// Initialize Last Mile service mix handling
			handleLastMileServiceMixChange();
			
			// Setup pickup frequency change handlers
			setupPickupFrequencyHandlers();
			
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				console.log('Form submitted, starting validation...');

			
				// Date validation
				if (!validateForecastDates()) {
					console.log('Date validation failed');
					return;
				}
				console.log('Date validation passed');

				// Check each validation step
				console.log('Company name:', company.value.trim().length > 0);
				console.log('Weekly shipments:', weeklyShip.value && !isNaN(weeklyShip.value) && Number(weeklyShip.value) >= 0);
				console.log('Weekly outbound:', weeklyOut.value && !isNaN(weeklyOut.value) && Number(weeklyOut.value) >= 0);
				console.log('Weekly inbound:', weeklyIn.value && !isNaN(weeklyIn.value) && Number(weeklyIn.value) >= 0);
				console.log('Inbound frequency:', inboundFreq.value);
				console.log('Date validation:', validateForecastDates());
				console.log('COD/PPD validation:', validateCodPpd());

				const isValidCompany = company.value.trim().length > 0;
				const isValidShipments = weeklyShip.value && !isNaN(weeklyShip.value) && Number(weeklyShip.value) >= 0;
				const isValidOutbound = weeklyOut.value && !isNaN(weeklyOut.value) && Number(weeklyOut.value) >= 0;
				const isValidInbound = weeklyIn.value && !isNaN(weeklyIn.value) && Number(weeklyIn.value) >= 0;
				const isValidInboundFreq = inboundFreq.value;
				const isValidAvgUnits = validateAvgUnits();
				const isValidServiceType = validateServiceType();
				const isValidCodPpd = validateCodPpd();
				const isValidTierSplit = true; // Tier split removed
				const isValidServiceMix = validateLastMileServiceMix();
				const isValidDates = validateForecastDates();

				const valid = (isValidCompany && isValidShipments && isValidOutbound && isValidInbound && isValidInboundFreq && isValidAvgUnits && isValidServiceType && isValidCodPpd && isValidServiceMix && isValidDates);
				
				if (!valid) {
					console.log('Form validation failed, cannot submit');
					return;
				}

				console.log('All validations passed, submitting form...');
				// Create submission matching the exact Supabase table schema
				const selectedServiceType = document.querySelector('input[name="service-type"]:checked');
				
				// Collect bundle data from the form
				const collectBundleData = () => {
					const bundleItems = document.querySelectorAll('.bundle-item');
					const bundles = [];
					bundleItems.forEach(item => {
						const nameInput = item.querySelector('.bundle-name');
						const detailsInput = item.querySelector('.bundle-details');
						if (nameInput && detailsInput) {
							const name = nameInput.value.trim();
							const details = detailsInput.value.trim();
							if (name || details) { // Only add if there's some content
								bundles.push({ name, details });
							}
						}
					});
					return bundles;
				};
				
				// Collect service details data
				const collectServiceDetails = (serviceType) => {
					const prefix = serviceType;
					const checkbox = document.getElementById(`service_${serviceType}`);
					
					if (!checkbox || !checkbox.checked) return null;
					
					// Collect time slots
					const timeSlots = [];
					const slotInputs = document.querySelectorAll(`[id^="${prefix}_time_slot"]`);
					slotInputs.forEach(input => {
						if (input.value) {
							timeSlots.push(input.value);
						}
					});
					
					// Helper function to safely get element value
					const getElementValue = (id, defaultValue = '') => {
						const element = document.getElementById(id);
						return element ? element.value || defaultValue : defaultValue;
					};
					
					return {
						pickup_frequency: getElementValue(`${prefix}_pickup_frequency`, ''),
						timeSlots: timeSlots,
						city: getElementValue(`${prefix}_city`, ''),
						district: getElementValue(`${prefix}_district`, ''),
						weekly_shipments: getElementValue(`${prefix}_weekly_shipments`, ''),
						cod_percent: getElementValue(`${prefix}_cod_percent`, ''),
						ppd_percent: getElementValue(`${prefix}_ppd_percent`, '')
					};
				};
				
				console.log('🔧 Form submission - avgUnits.value:', avgUnits.value, 'Type:', typeof avgUnits.value);
				console.log('🔧 Form submission - avgUnits element:', avgUnits);
				
				const newSubmission = {
					company_name: company.value.trim(),
					service_type: selectedServiceType ? selectedServiceType.value : null,
					weekly_shipments: Number(weeklyShip.value),
					weekly_units_outbound: Number(weeklyOut.value),
					weekly_units_inbound: Number(weeklyIn.value),
					forecast_start_date: forecastStartDate.value,
					forecast_end_date: forecastEndDate.value,
					seasonality_skus_notes: notes.value.trim(),
					special_bundles: JSON.stringify(collectBundleData()),
					special_bundles_notes: bundlesNotes ? bundlesNotes.value.trim() : '',
					inbound_frequency: inboundFreq.value,
					avg_units_per_shipment: Number(avgUnits.value),
					cod_percent: cod ? Number(cod.value) : 0,
					ppd_percent: ppd ? Number(ppd.value) : 0,
					service_mix: getSelectedLastMileServiceMix(),
					// Add service details
					hb_details: JSON.stringify(collectServiceDetails('hb')),
					international_details: JSON.stringify(collectServiceDetails('international')),
					parcel_details: JSON.stringify(collectServiceDetails('parcel'))
				};
				try {
					console.log('Submitting to Supabase:', newSubmission);
					const { data, error } = await window.supa.from('submissions').insert([newSubmission]);
					if (error) throw error;
					console.log('Data submitted successfully:', data);
					
					// Pass language preference to thank you page
					const thankYouUrl = currentLanguage === 'ar' ? 'thank-you.html?lang=ar' : 'thank-you.html?lang=en';
					const lang = translations[currentLanguage];
					showToast(lang.toastFormSuccess, 'success');
					setTimeout(() => {
						window.location.href = 'thank-you.html';
					}, 2000);
				} catch (err) {
					console.error('Error submitting data:', err);
					const lang = translations[currentLanguage];
					showToast(lang.toastFormError + err.message, 'error');
					
					// Even if database submission fails, redirect to thank you page
					// This ensures users don't get stuck on the form
					console.log('Database submission failed, but redirecting to thank you page...');
					setTimeout(() => {
						window.location.href = 'thank-you.html';
					}, 2000);
					window.location.href = thankYouUrl;
				}
			});
		}
		main();
	</script>
</body>

</html>